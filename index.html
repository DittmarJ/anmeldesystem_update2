<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferienprogramm Anmelde-App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (xlsx.js) for Excel file parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            margin: 0;
            padding: 1rem; /* Padding around the app */
        }
        /* Base styles for admin navigation buttons */
        .admin-nav-button {
            font-weight: 600; /* font-semibold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: all 0.2s ease-in-out; /* transition-all duration-200 */
            cursor: pointer;
            width: 100%; /* Make buttons take full width when stacked */
        }
        /* Default inactive state */
        .admin-nav-button:not(.active) {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-800 */
        }
        .admin-nav-button:not(.active):hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        /* Active state */
        .admin-nav-button.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
        }
        .admin-nav-button.active:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }

        /* Swipe-to-Reveal styles */
        .participant-item-container {
            position: relative;
            overflow: hidden; /* Hide the button initially */
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 0.5rem; /* spacing between items */
            cursor: grab; /* Indicates draggable nature */
        }
        .participant-item-container:active {
             cursor: grabbing;
        }

        .participant-content-wrapper {
            padding: 0.75rem 1rem; /* py-3 px-4 equivalent */
            background-color: #fff; /* Ensure it covers the button */
            position: relative;
            z-index: 10;
            transition: transform 0.3s ease-out; /* Smooth slide */
            touch-action: pan-y; /* Allow vertical scrolling, prevent horizontal by default */
        }

        .participant-action-button-container {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0; /* Button is always on the right */
            width: 100%; /* Take full width to simplify positioning */
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Align button to the right */
            transform: translateX(100%); /* Initially fully off-screen to the right */
            transition: transform 0.3s ease-out; /* Smooth slide */
            z-index: 5;
            padding-right: 1rem; /* Adjust padding for button */
        }

        /* When swiped, reveal the button and slide content */
        .participant-item-container.swiped .participant-action-button-container {
            transform: translateX(0); /* Button moves to cover the full width */
        }
        .participant-item-container.swiped .participant-content-wrapper {
             transform: translateX(-120px); /* Adjusted to reveal more of the button */
        }

        .participant-action-button {
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            white-space: nowrap; /* Prevent text wrapping */
        }

        /* Specific colors for action buttons */
        .participant-action-button.anmelden-button {
            background-color: #34d399; /* Tailwind green-500 */
            color: #ffffff;
            font-size: 0.875rem; /* text-sm */
        }
        .participant-action-button.abmelden-button {
            background-color: #ef4444; /* Tailwind red-500 */
            color: #ffffff;
            font-size: 0.875rem; /* text-sm */
        }


        /* Success message animation */
        #action-feedback-message {
            transform: translateY(-100%);
            opacity: 0;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }
        #action-feedback-message.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Info icon style */
        .info-icon {
            font-weight: bold;
            cursor: pointer;
            color: #60a5fa; /* Blue-400 */
            margin-left: 0.5rem;
            font-size: 1.1em;
            transition: color 0.2s ease-in-out;
        }
        .info-icon:hover {
            color: #3b82f6; /* Blue-500 */
        }

        /* NEW: Comment icon style */
        .comment-icon {
            background-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
            border-radius: 50%;
            width: 1.5em; /* Adjust size as needed */
            height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 0.5rem;
            flex-shrink: 0;
            cursor: help; /* Indicate it's informational */
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl mx-auto transform transition-all duration-300">
        <!-- Login Screen -->
        <div id="login-screen" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm</h1>
            <p class="text-center text-gray-600 mb-8">Bitte gib den Zugangscode ein.</p>

            <!-- Inner container for login screen content to keep it compact -->
            <div class="max-w-md mx-auto">
                <!-- Code Display -->
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center text-3xl font-semibold tracking-wider text-gray-800 mb-6 shadow-inner">
                    <span id="code-display"></span><span id="cursor" class="animate-pulse">|</span>
                </div>

                <!-- Keypad -->
                <div class="grid grid-cols-3 gap-4">
                    <!-- Numbers -->
                    <button class="keypad-button" data-value="1">1</button>
                    <button class="keypad-button" data-value="2">2</button>
                    <button class="keypad-button" data-value="3">3</button>
                    <button class="keypad-button" data-value="4">4</button>
                    <button class="keypad-button" data-value="5">5</button>
                    <button class="keypad-button" data-value="6">6</button>
                    <button class="keypad-button" data-value="7">7</button>
                    <button class="keypad-button" data-value="8">8</button>
                    <button class="keypad-button" data-value="9">9</button>
                    <!-- Backspace and 0 -->
                    <button class="keypad-button bg-red-500 hover:bg-red-600 active:bg-red-700 text-white" data-action="clear">⌫</button>
                    <button class="keypad-button" data-value="0">0</button>
                    <button class="keypad-button bg-green-500 hover:bg-green-600 active:bg-green-700 text-white" data-action="enter">✓</button>
                </div>

                <!-- Message Box for errors -->
                <div id="message-box" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden text-center" role="alert">
                    <!-- Error message will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Content Screen (for Betreuer - initially hidden) -->
        <div id="main-content-screen" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm An-/Abmeldung (Betreuer)</h2>
            <p class="text-center text-gray-600 mb-8">
                Willkommen, <span id="betreuer-name-display"></span>! Wische auf einem Teilnehmer nach links, um den An-/Abmelde-Button zu enthüllen. Klicke auf den Button, um Teilnehmer an oder abzumelden. Unter dem Infobutton kannst du Details einsehen und Kommentare erstellen. Sobald ein Kommentar bei einem Teilnehmer hinterlegt ist, findet sich ein (C) vor dem Infobutton. **Die Änderungen werden automatisch gespeichert.**
            </p>

            <!-- Action feedback message from top -->
            <div id="action-feedback-message" class="fixed top-0 left-0 w-full bg-green-500 text-white text-center py-3 transform -translate-y-full transition-all duration-500 ease-out z-50 shadow-lg">
                <!-- Message will be set by JS -->
            </div>

            <!-- The unified-participant-container content will be displayed here dynamically for Betreuer -->
            <!-- The actual unified-participant-container element is placed outside this div for shared use -->

            <button id="logout-button-main" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 active:bg-gray-500 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                Abmelden
            </button>
        </div>

        <!-- Admin Content Screen (new, initially hidden) -->
        <div id="admin-content-screen" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm Admin-Bereich</h2>
            <p class="text-center text-gray-600 mb-8">
                Willkommen im Admin-Bereich! Hier können Administratoren umfassende Einstellungen vornehmen.
            </p>

            <!-- Admin Navigation/Menu Band -->
            <div class="flex flex-col space-y-2 mb-6"> <!-- Changed to flex-col for vertical stacking -->
                <button id="nav-user-management" class="admin-nav-button">Benutzerverwaltung</button> <!-- Removed active class -->
                <button id="nav-participant-management" class="admin-nav-button">Teilnehmerverwaltung</button>
                <button id="nav-participant-overview" class="admin-nav-button">Teilnehmerübersicht</button>
                <button id="nav-program-settings" class="admin-nav-button">Programmeinstellungen</button>
            </div>

            <!-- Section Containers -->
            <div id="admin-section-wrapper" class="hidden"> <!-- Initially hidden -->
                <p id="admin-welcome-message" class="text-center text-gray-600 mb-4">Bitte wählen Sie eine der Optionen oben.</p> <!-- New message -->

                <div id="user-management-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Benutzerverwaltung</h3>

                    <!-- Add User Form -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Neuen Benutzer hinzufügen</h4>
                        <input type="text" id="new-username" placeholder="Benutzername" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-user-code" placeholder="Zugangscode (z.B. 1234)" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-user-status" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Betreuer">Betreuer</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button id="add-user-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-full transition-all duration-200">Benutzer hinzufügen</button>
                        <div id="add-user-message" class="mt-2 text-sm text-center hidden"></div>
                    </div>

                    <!-- User List -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Aktuelle Benutzer</h4>
                        <ul id="user-list" class="space-y-3">
                            <li id="no-users-message" class="text-center text-gray-500">Lade Benutzer...</li>
                        </ul>
                    </div>
                </div>

                <!-- Participant Management Section (NEW) -->
                <div id="participant-management-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Teilnehmerverwaltung</h3>

                    <!-- Add Participant Manually Form -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Neuen Teilnehmer manuell hinzufügen</h4>
                        <input type="text" id="new-participant-first-name" placeholder="Vorname" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-last-name" placeholder="Nachname" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-participant-regtype" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Tagesanmeldung">Tagesanmeldung</option>
                            <option value="Wochenanmeldung">Wochenanmeldung</option>
                        </select>
                        <input type="text" id="new-participant-street" placeholder="Straße" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-city" placeholder="Ort" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-phone" placeholder="Tel." class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="new-participant-paid" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="new-participant-paid" class="ml-2 block text-sm text-gray-900">Bezahlt</label>
                        </div>
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="new-participant-can-go-home-alone" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="new-participant-can-go-home-alone" class="ml-2 block text-sm text-gray-900">Darf alleine nach Hause</label>
                        </div>
                        <button id="add-participant-manual-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-full transition-all duration-200">Teilnehmer hinzufügen</button>
                        <div id="add-participant-manual-message" class="mt-2 text-sm text-center hidden"></div>
                    </div>

                    <!-- Import Participants from Excel -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Teilnehmer aus Excel importieren</h4>
                        <input type="file" id="import-participants-file-input" accept=".xlsx,.xls" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="import-participants-button" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg w-full transition-all duration-200">Excel importieren</button>
                        <div id="import-participants-message" class="mt-2 text-sm text-center hidden"></div>
                        <p class="text-xs text-gray-500 mt-2">Erwartetes Excel-Format (erste Zeile als Überschrift): Name,Vorname,Straße,Ort,Tel.,Darf alleine nach Hause?,Bezahlt?,**Anmeldeart** (optional: Tagesanmeldung/Wochenanmeldung). Beispiel: Mustermann,Max,Musterstr. 1,Musterstadt,0123456789,Nein,Ja,Tagesanmeldung</p>
                    </div>
                </div>

                <!-- NEW: Admin Participant Overview Section -->
                <div id="admin-participant-overview-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Teilnehmerübersicht</h3>
                    <p class="text-gray-600 mb-4">Hier siehst du alle Teilnehmer und ihren aktuellen Status.</p>
                    <!-- The unified-participant-container content will be displayed here dynamically -->
                </div>

                <!-- Program Settings Section -->
                <div id="program-settings-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Programmeinstellungen</h3>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="control-mode-toggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="control-mode-toggle" class="ml-2 block text-sm text-gray-900">Kontrollmodus aktivieren (unbezahlte Teilnehmer rot hervorheben)</label>
                    </div>

                    <div class="space-y-3 mt-6 border-t pt-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Datenverwaltung</h4>
                        <button id="remove-all-participants-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Alle Teilnehmer entfernen
                        </button>
                        <button id="remove-daily-participants-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Alle Tagesanmeldungen entfernen
                        </button>
                        <button id="reset-all-participants-button" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Status und Daten zurücksetzen
                        </button>
                    </div>
                </div>
            </div> <!-- End admin-section-wrapper -->

            <button id="logout-button-admin" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 active:bg-gray-500 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                Abmelden
            </button>
        </div>

        <!-- Unified Participant List Container - Moved to be a direct child of app-container, hidden by default -->
        <!-- This container will be toggled visible/hidden based on active screen/admin tab -->
        <div id="unified-participant-container" class="min-h-[200px] space-y-2 mt-6 hidden">
            <!-- Search Input -->
            <input type="text" id="participant-search-input" placeholder="Teilnehmer suchen..." class="w-full p-2 mb-4 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <ul id="unified-participant-list" class="space-y-2">
                <!-- All participants will be rendered here -->
            </ul>
            <p id="no-participants-message-unified" class="text-center text-gray-500 text-sm mt-4 hidden">Noch keine Teilnehmer vorhanden.</p>
        </div>

        <!-- Delete Confirmation Modal (Reused for other confirmations) -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 id="delete-modal-title" class="text-xl font-bold mb-4">Bestätigung</h3>
                <p id="delete-modal-message" class="mb-6">Bist du sicher, dass du <span id="delete-item-display" class="font-semibold"></span> löschen möchtest?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                    <button id="confirm-delete" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Bestätigen</button> <!-- Changed to blue -->
                </div>
            </div>
        </div>

        <!-- Participant Details Modal -->
        <div id="participant-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 id="details-modal-title" class="text-xl font-bold mb-4 text-gray-800">Teilnehmerdetails</h3>
                <div id="details-content-scrollable" class="max-h-[70vh] overflow-y-auto pr-2"> <!-- Added for scrolling -->
                    <div class="space-y-3 text-gray-700">
                        <!-- Editable Name Fields -->
                        <p>
                            <strong>Vorname:</strong>
                            <span id="details-first-name-display"></span>
                            <input type="text" id="details-first-name-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Nachname:</strong>
                            <span id="details-last-name-display"></span>
                            <input type="text" id="details-last-name-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        
                        <!-- Editable Text Fields -->
                        <p>
                            <strong>Straße:</strong>
                            <span id="details-street-display"></span>
                            <input type="text" id="details-street-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Ort:</strong>
                            <span id="details-city-display"></span>
                            <input type="text" id="details-city-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Tel.:</strong>
                            <span id="details-phone-display"></span>
                            <input type="text" id="details-phone-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Anmeldungstyp:</strong>
                            <span id="details-regtype-display"></span>
                            <select id="details-regtype-select" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Tagesanmeldung">Tagesanmeldung</option>
                                <option value="Wochenanmeldung">Wochenanmeldung</option>
                            </select>
                        </p>

                        <!-- Editable Checkboxes -->
                        <div class="flex items-center">
                            <strong>Bezahlt:</strong>
                            <span id="details-paid-display" class="ml-2"></span>
                            <input type="checkbox" id="details-paid-input" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ml-2 hidden">
                        </div>
                        <div class="flex items-center">
                            <strong>Darf alleine nach Hause:</strong>
                            <span id="details-can-go-home-alone-display" class="ml-2"></span>
                            <input type="checkbox" id="details-can-go-home-alone-input" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ml-2 hidden">
                        </div>
                        
                        <p id="details-picked-up-by-row" class="hidden"><strong>Abgeholt von:</strong> <span id="details-picked-up-by"></span></p>
                    </div>

                    <!-- Comment Section -->
                    <div id="details-comment-section" class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Kommentare</h4>
                        <div id="details-comments-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto border p-2 rounded bg-gray-50">
                            <!-- Comments will be populated here -->
                            <p class="text-gray-500 text-sm italic" id="no-comments-message">Noch keine Kommentare vorhanden.</p>
                        </div>
                        <textarea id="new-comment-text" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Neuen Kommentar hinzufügen..."></textarea>
                        <button id="add-comment-button" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">Kommentar hinzufügen</button>
                    </div>

                    <!-- Activity History Section -->
                    <div id="details-activity-history-container" class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Aktivitäten</h4>
                        <ul id="details-activity-history" class="space-y-1 text-sm">
                            <!-- History entries will be populated here -->
                        </ul>
                        <p id="no-history-message" class="text-gray-500 text-sm hidden">Keine Aktivitäten vorhanden.</p>
                    </div>
                </div> <!-- End of details-content-scrollable -->
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="save-details-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Speichern</button>
                    <button id="close-details-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Schließen</button>
                </div>
            </div>
        </div>

        <!-- Pickup Confirmation Modal -->
        <div id="pickup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Teilnehmer abholen</h3>
                <p class="mb-4">Bitte bestätige, wer <span id="pickup-participant-name" class="font-semibold"></span> abgeholt hat:</p>
                
                <div class="space-y-3 mb-6">
                    <div>
                        <label for="pickup-person-select" class="block text-sm font-medium text-gray-700 mb-1">Abholperson auswählen:</label>
                        <select id="pickup-person-select" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Bitte auswählen</option>
                            <option value="Mutter">Mutter</option>
                            <option value="Vater">Vater</option>
                            <option value="Oma">Oma</option>
                            <option value="Opa">Opa</option>
                            <option value="Geschwister">Geschwister</option>
                            <option value="Sonstige">Sonstige (bitte angeben)</option>
                        </select>
                    </div>
                    <div id="custom-pickup-person-container" class="hidden">
                        <label for="custom-pickup-person-input" class="block text-sm font-medium text-gray-700 mb-1">Name der abholenden Person:</label>
                        <input type="text" id="custom-pickup-person-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Name der abholenden Person">
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="cancel-pickup" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                    <button id="confirm-pickup" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Bestätigen</button>
                </div>
                <div id="pickup-message-box" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden text-center" role="alert"></div>
            </div>
        </div>

        <script>
            // DOM elements
            const loginScreen = document.getElementById('login-screen');
            const mainContentScreen = document.getElementById('main-content-screen');
            const adminContentScreen = document.getElementById('admin-content-screen');
            const codeDisplay = document.getElementById('code-display');
            const keypadButtons = document.querySelectorAll('.keypad-button');
            const logoutButtonMain = document.getElementById('logout-button-main');
            const logoutButtonAdmin = document.getElementById('logout-button-admin');
            const messageBox = document.getElementById('message-box');
            const betreuerNameDisplay = document.getElementById('betreuer-name-display'); // New element for Betreuer name

            // Admin User Management Elements
            const newUsernameInput = document.getElementById('new-username');
            const newUserCodeInput = document.getElementById('new-user-code');
            const newUserStatusSelect = document.getElementById('new-user-status');
            const addUserButton = document.getElementById('add-user-button');
            const addUserMessage = document.getElementById('add-user-message');
            const userListElement = document.getElementById('user-list');
            const noUsersMessage = document.getElementById('no-users-message');

            // Participant List Elements (shared between Betreuer and Admin Overview)
            const unifiedParticipantContainer = document.getElementById('unified-participant-container');
            const unifiedParticipantList = document.getElementById('unified-participant-list');
            const noParticipantsMessageUnified = document.getElementById('no-participants-message-unified');
            const actionFeedbackMessage = document.getElementById('action-feedback-message');
            const participantActionsDiv = document.getElementById('participant-actions'); // This div is now always hidden
            const participantSearchInput = document.getElementById('participant-search-input'); // NEW

            const deleteModal = document.getElementById('delete-modal');
            const deleteModalTitle = document.getElementById('delete-modal-title'); // NEW
            const deleteModalMessage = document.getElementById('delete-modal-message'); // NEW
            const deleteItemDisplay = document.getElementById('delete-item-display');
            const cancelDeleteButton = document.getElementById('cancel-delete');
            const confirmDeleteButton = document.getElementById('confirm-delete');

            // Participant Details Modal Elements
            const participantDetailsModal = document.getElementById('participant-details-modal');
            const detailsModalTitle = document.getElementById('details-modal-title');
            
            // Detail display spans
            const detailsFirstNameDisplay = document.getElementById('details-first-name-display');
            const detailsLastNameDisplay = document.getElementById('details-last-name-display');
            const detailsStreetDisplay = document.getElementById('details-street-display');
            const detailsCityDisplay = document.getElementById('details-city-display');
            const detailsPhoneDisplay = document.getElementById('details-phone-display');
            const detailsRegtypeDisplay = document.getElementById('details-regtype-display');
            const detailsPaidDisplay = document.getElementById('details-paid-display');
            const detailsCanGoHomeAloneDisplay = document.getElementById('details-can-go-home-alone-display');

            // Detail input fields (for admin editing)
            const detailsFirstNameInput = document.getElementById('details-first-name-input');
            const detailsLastNameInput = document.getElementById('details-last-name-input');
            const detailsStreetInput = document.getElementById('details-street-input');
            const detailsCityInput = document.getElementById('details-city-input');
            const detailsPhoneInput = document.getElementById('details-phone-input');
            const detailsRegtypeSelect = document.getElementById('details-regtype-select');
            const detailsPaidInput = document.getElementById('details-paid-input');
            const detailsCanGoHomeAloneInput = document.getElementById('details-can-go-home-alone-input');

            const detailsPickedUpBy = document.getElementById('details-picked-up-by');
            const detailsPickedUpByRow = document.getElementById('details-picked-up-by-row');
            const closeDetailsModalButton = document.getElementById('close-details-modal');
            const saveDetailsButton = document.getElementById('save-details-button'); // New save button for details

            const detailsActivityHistory = document.getElementById('details-activity-history'); // New element
            const noHistoryMessage = document.getElementById('no-history-message'); // New element

            // Comment Section Elements
            const detailsCommentSection = document.getElementById('details-comment-section');
            const detailsCommentsList = document.getElementById('details-comments-list');
            const newCommentText = document.getElementById('new-comment-text');
            const addCommentButton = document.getElementById('add-comment-button');
            const noCommentsMessage = document.getElementById('no-comments-message');


            // Pickup Confirmation Modal Elements
            const pickupModal = document.getElementById('pickup-modal');
            const pickupParticipantName = document.getElementById('pickup-participant-name');
            const pickupPersonSelect = document.getElementById('pickup-person-select');
            const customPickupPersonContainer = document.getElementById('custom-pickup-person-container');
            const customPickupPersonInput = document.getElementById('custom-pickup-person-input');
            const cancelPickupButton = document.getElementById('cancel-pickup');
            const confirmPickupButton = document.getElementById('confirm-pickup');
            const pickupMessageBox = document.getElementById('pickup-message-box');

            // Admin Participant Management Elements
            const navParticipantManagementButton = document.getElementById('nav-participant-management');
            const participantManagementSection = document.getElementById('participant-management-section');
            const newParticipantFirstNameInput = document.getElementById('new-participant-first-name');
            const newParticipantLastNameInput = document.getElementById('new-participant-last-name');
            const newParticipantRegtypeSelect = document.getElementById('new-participant-regtype');
            const newParticipantStreetInput = document.getElementById('new-participant-street');
            const newParticipantCityInput = document.getElementById('new-participant-city');
            const newParticipantPhoneInput = document.getElementById('new-participant-phone');
            const newParticipantPaidCheckbox = document.getElementById('new-participant-paid');
            const newParticipantCanGoHomeAloneCheckbox = document.getElementById('new-participant-can-go-home-alone');
            const addParticipantManualButton = document.getElementById('add-participant-manual-button');
            const addParticipantManualMessage = document.getElementById('add-participant-manual-message');
            const importParticipantsFileInput = document.getElementById('import-participants-file-input');
            const importParticipantsButton = document.getElementById('import-participants-button');
            const importParticipantsMessage = document.getElementById('import-participants-message');

            // Admin Program Settings elements
            const controlModeToggle = document.getElementById('control-mode-toggle');
            const removeAllParticipantsButton = document.getElementById('remove-all-participants-button'); // NEW
            const removeDailyParticipantsButton = document.getElementById('remove-daily-participants-button'); // NEW
            const resetAllParticipantsButton = document.getElementById('reset-all-participants-button'); // NEW

            // NEW: Admin Participant Overview elements
            const navParticipantOverviewButton = document.getElementById('nav-participant-overview');
            const adminParticipantOverviewSection = document.getElementById('admin-participant-overview-section');


            // Admin Navigation elements
            const navUserManagementButton = document.getElementById('nav-user-management');
            const navProgramSettingsButton = document.getElementById('nav-program-settings');
            const userManagementSection = document.getElementById('user-management-section');
            const programSettingsSection = document.getElementById('program-settings-section');
            const adminNavButtons = document.querySelectorAll('.admin-nav-button');
            const adminSectionWrapper = document.getElementById('admin-section-wrapper'); // NEW
            const adminWelcomeMessage = document.getElementById('admin-welcome-message'); // NEW

            // Geänderte Variablen von 'let' zu 'var', um "SyntaxError: Cannot declare a let variable twice" zu vermeiden
            var enteredCode = '';
            var itemToDelete = null; // Reused for general confirmations
            var activeSwipeItem = null; // Refers to the participant-content-wrapper element
            var initialX = 0;
            var currentTranslateX = 0;
            var isSwiping = false;
            var currentParticipantBeingPickedUp = null; // Stores the participant object for the pickup modal
            var currentLoggedInUsername = ''; // Global variable for logged-in user's name
            var currentLoggedInUserStatus = ''; // Global variable for logged-in user's status (admin/Betreuer)
            var controlModeActive = false; // Initial state for control mode
            var currentParticipantInDetailsModal = null; // Stores the participant object currently displayed in the details modal


            // Globale Funktion zum Anzeigen von Nachrichten (Fehler oder Erfolg)
            window.showMessage = function(message, isError = true) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                if (isError) {
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    messageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    messageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            };

            // Funktion zum Anzeigen der Aktions-Feedback-Nachricht (von oben)
            function showActionFeedback(message, isSuccess = true) {
                actionFeedbackMessage.textContent = message;
                actionFeedbackMessage.classList.remove('bg-green-500', 'bg-red-500');
                actionFeedbackMessage.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
                actionFeedbackMessage.classList.add('show');
                setTimeout(() => {
                    actionFeedbackMessage.classList.remove('show');
                }, 2000);
            }

            function showPickupMessageBox(message, isError = true) {
                pickupMessageBox.textContent = message;
                pickupMessageBox.classList.remove('hidden');
                if (isError) {
                    pickupMessageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    pickupMessageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    pickupMessageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    pickupMessageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                }
                setTimeout(() => {
                    pickupMessageBox.classList.add('hidden');
                }, 3000);
            }

            function showAdminMessage(messageElement, message, isError = true) {
                messageElement.textContent = message;
                messageElement.classList.remove('hidden', 'text-red-700', 'text-green-700');
                if (isError) {
                    messageElement.classList.add('text-red-700');
                } else {
                    messageElement.classList.add('text-green-700');
                }
                setTimeout(() => messageElement.classList.add('hidden'), 3000);
            }

            // --- Local Storage Management für Benutzer ---
            const LOCAL_STORAGE_USERS_KEY = 'ferienprogramm_users';
            let users = [];

            function loadUsers() {
                try {
                    const storedUsers = localStorage.getItem(LOCAL_STORAGE_USERS_KEY);
                    if (storedUsers) {
                        users = JSON.parse(storedUsers);
                    } else {
                        users = [
                            { id: Date.now().toString() + '0', username: 'Betreuer', code: '1111', status: 'Betreuer' },
                            { id: Date.now().toString() + '1', username: 'Admin', code: '240309', status: 'admin' }
                        ];
                        saveUsers();
                    }
                } catch (e) {
                    console.error("Fehler beim Laden der Benutzer aus Local Storage:", e);
                    window.showMessage("Fehler beim Laden der Benutzerdaten.", true);
                    users = [];
                }
            }

            function saveUsers() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_USERS_KEY, JSON.stringify(users));
                    renderUserList();
                }
                catch (e) {
                    console.error("Fehler beim Speichern der Benutzer in Local Storage:", e);
                    window.showMessage("Fehler beim Speichern der Benutzerdaten.", true);
                }
            }

            // --- Local Storage Management für Teilnehmer ---
            const LOCAL_STORAGE_PARTICIPANTS_KEY = 'ferienprogramm_participants';
            const LOCAL_STORAGE_CONTROL_MODE_KEY = 'ferienprogramm_control_mode'; // New key for control mode

            let participants = [];

            function loadParticipants() {
                try {
                    const storedParticipants = localStorage.getItem(LOCAL_STORAGE_PARTICIPANTS_KEY);
                    if (storedParticipants) {
                        participants = JSON.parse(storedParticipants).map(p => ({
                            ...p,
                            savedStatus: p.status, // Ensure savedStatus is always present for internal state management
                            registrationType: p.registrationType || 'Tagesanmeldung',
                            street: p.street || '',
                            city: p.city || '',
                            phone: p.phone || '', // Initialize new phone field
                            paid: p.paid !== undefined ? p.paid : false,
                            canGoHomeAlone: p.canGoHomeAlone !== undefined ? p.canGoHomeAlone : false,
                            pickedUpBy: p.pickedUpBy || '',
                            activityHistory: p.activityHistory || [], // Initialize activityHistory
                            comments: p.comments || [] // NEW: Initialize comments array
                        }));
                    } else {
                        // Initial dummy data for participants
                        participants = [
                            { id: Date.now().toString() + 'A', name: 'Lea Schneider', status: 'available', savedStatus: 'available', registrationType: 'Tagesanmeldung', street: 'Musterweg 1', city: 'Musterstadt', phone: '01761234567', paid: true, canGoHomeAlone: false, pickedUpBy: '', activityHistory: [], comments: [] },
                            { id: Date.now().toString() + 'B', name: 'Max Mustermann', status: 'available', savedStatus: 'available', registrationType: 'Wochenanmeldung', street: 'Beispielallee 5', city: 'Beispielort', phone: '01519876543', paid: false, canGoHomeAlone: true, pickedUpBy: '', activityHistory: [], comments: [] },
                            { id: Date.now().toString() + 'C', name: 'Anna Schmidt', status: 'available', savedStatus: 'available', registrationType: 'Tagesanmeldung', street: 'Hauptstr. 10', city: 'Dorf', phone: '01701122334', paid: true, canGoHomeAlone: true, pickedUpBy: '', activityHistory: [], comments: [] },
                            { id: Date.now().toString() + 'D', name: 'Tom Müller', status: 'available', savedStatus: 'available', registrationType: 'Wochenanmeldung', street: 'Nebenweg 7', city: 'Kleinstadt', phone: '01605566778', paid: false, canGoHomeAlone: false, pickedUpBy: '', activityHistory: [], comments: [] }
                        ];
                        saveParticipantsToLocalStorage();
                    }
                } catch (e) {
                    console.error("Fehler beim Laden der Teilnehmer aus Local Storage:", e);
                    window.showMessage("Fehler beim Laden der Teilnehmerdaten.", true);
                    participants = [];
                }
            }

            function saveParticipantsToLocalStorage() {
                try {
                    // Save only the essential data, not savedStatus which is temporary internal state
                    const participantsToSave = participants.map(p => ({
                        id: p.id,
                        name: p.name,
                        status: p.status,
                        registrationType: p.registrationType,
                        street: p.street,
                        city: p.city,
                        phone: p.phone, // Include phone in saved data
                        paid: p.paid,
                        canGoHomeAlone: p.canGoHomeAlone,
                        pickedUpBy: p.pickedUpBy,
                        activityHistory: p.activityHistory, // NEW: Save activityHistory
                        comments: p.comments // NEW: Save comments
                    }));
                    localStorage.setItem(LOCAL_STORAGE_PARTICIPANTS_KEY, JSON.stringify(participantsToSave));
                    renderParticipantList(); // Re-render the list after saving
                } catch (e) {
                    console.error("Fehler beim Speichern der Teilnehmer in Local Storage:", e);
                    window.showMessage("Fehler beim Speichern der Teilnehmerdaten.", true);
                }
            }

            function loadControlMode() {
                try {
                    const storedControlMode = localStorage.getItem(LOCAL_STORAGE_CONTROL_MODE_KEY);
                    controlModeActive = storedControlMode === 'true'; // Convert string to boolean
                    controlModeToggle.checked = controlModeActive; // Set checkbox state
                } catch (e) {
                    console.error("Fehler beim Laden des Kontrollmodus aus Local Storage:", e);
                    controlModeActive = false;
                }
            }

            function saveControlMode() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_CONTROL_MODE_KEY, controlModeActive); // Save boolean as string
                } catch (e) {
                    console.error("Fehler beim Speichern des Kontrollmodus in Local Storage:", e);
                }
            }

            function updateCodeDisplay() {
                codeDisplay.textContent = '*'.repeat(enteredCode.length);
            }

            // Function to manage which admin section is visible
            function showAdminSection(sectionId) {
                // Hide all admin sections
                userManagementSection.classList.add('hidden');
                participantManagementSection.classList.add('hidden');
                adminParticipantOverviewSection.classList.add('hidden'); // NEW: Hide overview section
                programSettingsSection.classList.add('hidden');
                adminWelcomeMessage.classList.add('hidden'); // Hide welcome message when a section is active

                // Deactivate all navigation buttons
                adminNavButtons.forEach(button => {
                    button.classList.remove('active');
                });

                // Control visibility of the shared participant list container
                unifiedParticipantContainer.classList.add('hidden');
                
                // Show the admin section wrapper if a specific section is chosen, otherwise hide it and show welcome message
                if (sectionId) { // If sectionId is not empty
                    adminSectionWrapper.classList.remove('hidden'); // Show the wrapper
                    // Show the selected section and activate its button
                    if (sectionId === 'user-management-section') {
                        userManagementSection.classList.remove('hidden');
                        navUserManagementButton.classList.add('active');
                    } else if (sectionId === 'participant-management-section') {
                        participantManagementSection.classList.remove('hidden');
                        navParticipantManagementButton.classList.add('active');
                    } else if (sectionId === 'admin-participant-overview-section') { // NEW: Participant Overview
                        adminParticipantOverviewSection.classList.remove('hidden');
                        navParticipantOverviewButton.classList.add('active');
                        unifiedParticipantContainer.classList.remove('hidden'); // Show the unified list
                        renderParticipantList(); // Render to the unified list
                    } else if (sectionId === 'program-settings-section') {
                        programSettingsSection.classList.remove('hidden');
                        navProgramSettingsButton.classList.add('active');
                    }
                } else { // If sectionId is empty, no section is open
                    adminSectionWrapper.classList.add('hidden'); // Hide the wrapper
                    adminWelcomeMessage.classList.remove('hidden'); // Show welcome message
                }
            }


            keypadButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const value = button.dataset.value;
                    const action = button.dataset.action;

                    messageBox.classList.add('hidden');

                    if (value) {
                        if (enteredCode.length < 6) {
                            enteredCode += value;
                        }
                    } else if (action === 'clear') {
                        enteredCode = enteredCode.slice(0, -1);
                    } else if (action === 'enter') {
                        const foundUser = users.find(user => user.code === enteredCode);

                        if (foundUser) {
                            loginScreen.classList.add('hidden');
                            enteredCode = '';
                            updateCodeDisplay();
                            currentLoggedInUsername = foundUser.username; // Set username on login
                            currentLoggedInUserStatus = foundUser.status; // Set user status on login

                            if (foundUser.status === 'admin') {
                                mainContentScreen.classList.add('hidden');
                                adminContentScreen.classList.remove('hidden');
                                // Initially, no section is open for admin
                                showAdminSection(''); // Call with empty string to show welcome message
                                unifiedParticipantContainer.classList.add('hidden'); // Hide the unified list initially
                                window.showMessage(`Willkommen, Admin ${foundUser.username}!`, false);
                            } else if (foundUser.status === 'Betreuer') {
                                adminContentScreen.classList.add('hidden');
                                mainContentScreen.classList.remove('hidden');
                                unifiedParticipantContainer.classList.remove('hidden'); // Show the unified list for Betreuer
                                
                                // Set the Betreuer's name in the welcome message
                                betreuerNameDisplay.textContent = foundUser.username;

                                renderParticipantList(); // Ensure it's rendered for Betreuer
                                // Removed window.showMessage here as the message is now static in HTML
                            }
                        } else {
                            window.showMessage('Falscher Code oder Benutzer nicht gefunden. Bitte versuche es erneut.');
                            enteredCode = '';
                        }
                    }
                    updateCodeDisplay();
                });
            });

            // Add User functionality (Admin)
            addUserButton.addEventListener('click', () => {
                const username = newUsernameInput.value.trim();
                const code = newUserCodeInput.value.trim();
                const status = newUserStatusSelect.value;

                if (!username || !code) {
                    showAdminMessage(addUserMessage, "Bitte Benutzername und Zugangscode eingeben.", true);
                    return;
                }

                const codeExists = users.some(user => user.code === code);
                if (codeExists) {
                    showAdminMessage(addUserMessage, "Dieser Zugangscode wird bereits verwendet. Bitte einen anderen wählen.", true);
                    return;
                }

                const newUser = {
                    id: Date.now().toString(),
                    username,
                    code,
                    status
                };

                users.push(newUser);
                saveUsers();

                showAdminMessage(addUserMessage, "Benutzer erfolgreich hinzugefügt!", false);

                newUsernameInput.value = '';
                newUserCodeInput.value = '';
                newUserStatusSelect.value = 'Betreuer';
            });

            function renderUserList() {
                userListElement.innerHTML = '';
                if (users.length === 0) {
                    userListElement.innerHTML = `<li id="no-users-message" class="text-center text-gray-500">Noch keine Benutzer vorhanden.</li>`;
                    return;
                }

                users.forEach(userData => {
                    const listItem = document.createElement('li');
                    listItem.className = 'bg-white p-3 rounded-lg shadow-sm flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0';
                    listItem.innerHTML = `
                        <div class="flex-grow">
                            <span class="font-semibold">${userData.username}</span>
                            <span class="text-gray-500 text-sm ml-2">(${'*'.repeat(userData.code.length)})</span>
                            <span class="text-gray-600 text-sm ml-2">- ${userData.status}</span>
                        </div>
                        <div class="flex space-x-2 mt-2 sm:mt-0">
                            <button data-id="${userData.id}" data-status="${userData.status}" class="change-user-status-button text-blue-500 hover:text-blue-700 text-sm font-medium">
                                Status ändern (${userData.status === 'admin' ? 'Betreuer' : 'Admin'})
                            </button>
                            <button data-id="${userData.id}" data-username="${userData.username}" data-type="user" class="delete-item-button text-blue-500 hover:text-blue-700 text-sm font-medium"> <!-- Changed to blue -->
                                Entfernen
                            </button>
                        </div>
                    `;
                    userListElement.appendChild(listItem);
                });
            }

            // --- Swipe-to-Reveal Logik für Teilnehmer ---
            var initialX = 0;
            var currentTranslateX = 0;
            var isSwiping = false;
            var activeSwipeItem = null;

            function closeAllSwipedItems(excludeContentWrapper = null) {
                document.querySelectorAll('.participant-item-container.swiped').forEach(item => {
                    const contentWrapper = item.querySelector('.participant-content-wrapper');
                    if (contentWrapper && contentWrapper !== excludeContentWrapper) {
                        contentWrapper.style.transform = `translateX(0px)`;
                    }
                    item.classList.remove('swiped');
                });
            }

            function handlePointerDown(e) {
                if (e.button !== 0 && e.pointerType !== 'touch') return;
                closeAllSwipedItems(this);
                activeSwipeItem = this;
                isSwiping = true;
                initialX = e.clientX || e.touches[0].clientX;
                currentTranslateX = 0;
                this.setPointerCapture(e.pointerId);
            }

            function handlePointerMove(e) {
                if (!isSwiping || !activeSwipeItem) return;

                const clientX = e.clientX || e.touches[0].clientX;
                const deltaX = clientX - initialX;

                const contentWrapper = activeSwipeItem;
                const buttonWidth = 120;

                currentTranslateX = Math.min(0, deltaX);
                currentTranslateX = Math.max(-buttonWidth, currentTranslateX);

                contentWrapper.style.transform = `translateX(${currentTranslateX}px)`;
            }

            function handlePointerUp(e) {
                if (!isSwiping || !activeSwipeItem) return;

                isSwiping = false;
                activeSwipeItem.releasePointerCapture(e.pointerId);

                const contentWrapper = activeSwipeItem;
                const parentItemContainer = activeSwipeItem.parentNode;
                const swipeThreshold = 40;
                const buttonWidth = 120;

                if (currentTranslateX < -swipeThreshold) {
                    contentWrapper.style.transform = `translateX(-${buttonWidth}px)`;
                    parentItemContainer.classList.add('swiped');
                } else {
                    contentWrapper.style.transform = `translateX(0px)`;
                    parentItemContainer.classList.remove('swiped');
                }
                currentTranslateX = 0;

                if (activeSwipeItem === this) {
                    activeSwipeItem = null;
                }
            }

            function handlePointerCancel(e) {
                if (!isSwiping || !activeSwipeItem) return;

                isSwiping = false;
                activeSwipeItem.releasePointerCapture(e.pointerId);

                const contentWrapper = activeSwipeItem;
                const parentItemContainer = activeSwipeItem.parentNode;

                contentWrapper.style.transform = `translateX(0px)`;
                parentItemContainer.classList.remove('swiped');
                currentTranslateX = 0;

                if (activeSwipeItem === this) {
                    activeSwipeItem = null;
                }
            }

            function renderParticipantList() {
                unifiedParticipantList.innerHTML = '';
                let hasParticipants = false;

                const searchTerm = participantSearchInput.value.toLowerCase();

                // Sortierung nach Alphabet des Vornamens
                const sortedParticipants = [...participants].sort((a, b) => {
                    // Split name to compare by first name if format is "FirstName LastName"
                    const nameA = a.name.split(' ')[0] || a.name;
                    const nameB = b.name.split(' ')[0] || b.name;
                    return nameA.localeCompare(nameB);
                }).filter(participant => participant.name.toLowerCase().includes(searchTerm));


                sortedParticipants.forEach(participantData => {
                    const listItem = document.createElement('li');
                    listItem.className = `participant-item-container ${participantData.status}`;
                    listItem.dataset.id = participantData.id;
                    listItem.dataset.status = participantData.status;

                    const actionButtonText = (participantData.status === 'available') ? 'Anmelden' : 'Abmelden';
                    const buttonClass = (participantData.status === 'available') ? 'anmelden-button' : 'abmelden-button';
                    
                    // Logic for dot color
                    let dotColorClass = '';
                    if (participantData.status === 'signedIn') {
                        dotColorClass = 'bg-green-500'; // Green if signed in
                    } else if (participantData.activityHistory.length === 0) {
                        dotColorClass = 'bg-gray-400'; // Gray if no actions yet (initial state)
                    } else {
                        dotColorClass = 'bg-red-500'; // Red if available AND has history (signed out)
                    }

                    // Define canGoHomeAloneText here
                    const canGoHomeAloneText = participantData.canGoHomeAlone ? 'Ja' : 'Nein';

                    // Apply red text if control mode is active and paid is false
                    const nameTextColorClass = (controlModeActive && !participantData.paid) ? 'text-red-500' : '';

                    // NEW: Comment indicator HTML
                    const commentIndicator = (participantData.comments && participantData.comments.length > 0) ? '(C) ' : '';


                    listItem.innerHTML = `
                        <div class="participant-action-button-container">
                            <button class="participant-action-button ${buttonClass}" data-action="${actionButtonText.toLowerCase()}" data-id="${participantData.id}">
                                ${actionButtonText}
                            </button>
                        </div>
                        <div class="participant-content-wrapper p-3 bg-white flex items-center">
                            <span class="w-3 h-3 rounded-full ${dotColorClass} mr-2 flex-shrink-0"></span>
                            <span class="font-semibold flex-grow ${nameTextColorClass}">${participantData.name}</span>
                            <span class="text-gray-500 text-xs block ml-2 flex-shrink-0">${participantData.registrationType} | Alleine: ${canGoHomeAloneText}</span>
                            ${commentIndicator ? `<span class="comment-icon" title="Kommentare vorhanden">&#x24B8;</span>` : ''} <!-- Render icon only if comments exist -->
                            <span class="info-icon" data-id="${participantData.id}">&#x2139;</span>
                        </div>
                    `;

                    unifiedParticipantList.appendChild(listItem);
                    hasParticipants = true;

                    const contentWrapper = listItem.querySelector('.participant-content-wrapper');
                    contentWrapper.addEventListener('pointerdown', handlePointerDown);
                    contentWrapper.addEventListener('pointermove', handlePointerMove);
                    contentWrapper.addEventListener('pointerup', handlePointerUp);
                    contentWrapper.addEventListener('pointercancel', handlePointerCancel);
                });

                noParticipantsMessageUnified.classList.toggle('hidden', hasParticipants);
            }

            // Function to update the visibility of display spans vs input fields for admin editing
            function setAdminEditMode(isEditing) {
                const displayElements = [
                    detailsFirstNameDisplay, detailsLastNameDisplay, detailsStreetDisplay, detailsCityDisplay,
                    detailsPhoneDisplay, detailsRegtypeDisplay, detailsPaidDisplay, detailsCanGoHomeAloneDisplay
                ];
                const inputElements = [
                    detailsFirstNameInput, detailsLastNameInput, detailsStreetInput, detailsCityInput,
                    detailsPhoneInput, detailsRegtypeSelect, detailsPaidInput, detailsCanGoHomeAloneInput
                ];

                displayElements.forEach(el => el.classList.toggle('hidden', isEditing));
                inputElements.forEach(el => el.classList.toggle('hidden', !isEditing));
                saveDetailsButton.classList.toggle('hidden', !isEditing);
            }

            // Event-Listener für Teilnehmer-Aktions-Buttons (Anmelden/Abmelden) und Info-Icon
            document.addEventListener('click', (event) => {
                const target = event.target;

                if (target.classList.contains('participant-action-button')) {
                    const participantId = target.dataset.id;
                    const action = target.dataset.action;
                    const participantIndex = participants.findIndex(p => p.id === participantId);
                    const participant = participants[participantIndex];

                    if (participantIndex > -1) {
                        closeAllSwipedItems();

                        if (action === 'anmelden' && participant.status === 'available') {
                            participant.status = 'signedIn';
                            participant.savedStatus = 'signedIn';
                            participant.pickedUpBy = ''; // Reset pickedUpBy on sign-in
                            const historyEntry = {
                                type: 'Angemeldet',
                                time: new Date().toLocaleString('de-DE'), // Use de-DE locale for German date format
                                by: currentLoggedInUsername || 'Unbekannt' // Log the user who signed in
                            };
                            participant.activityHistory.push(historyEntry); // Add to history
                            showActionFeedback(`Teilnehmer "${participant.name}" angemeldet!`, true);
                            saveParticipantsToLocalStorage();
                        } else if (action === 'abmelden' && participant.status === 'signedIn') {
                            if (!participant.canGoHomeAlone) {
                                currentParticipantBeingPickedUp = participant;
                                pickupParticipantName.textContent = participant.name;
                                pickupPersonSelect.value = "";
                                customPickupPersonInput.value = "";
                                customPickupPersonContainer.classList.add('hidden');
                                pickupMessageBox.classList.add('hidden');
                                pickupModal.classList.remove('hidden');
                            } else {
                                participant.status = 'available';
                                participant.savedStatus = 'available';
                                participant.pickedUpBy = 'Alleine nach Hause';
                                const historyEntry = {
                                    type: 'Abgemeldet',
                                    time: new Date().toLocaleString('de-DE'),
                                    by: currentLoggedInUsername || 'Unbekannt',
                                    pickup: 'Alleine nach Hause' // Explicitly note pickup if gone alone
                                };
                                participant.activityHistory.push(historyEntry); // Add to history
                                showActionFeedback(`Teilnehmer "${participant.name}" abgemeldet.`, false);
                                saveParticipantsToLocalStorage();
                            }
                        }
                    }
                } else if (target.classList.contains('info-icon')) {
                    const participantId = target.dataset.id;
                    currentParticipantInDetailsModal = participants.find(p => p.id === participantId);

                    if (currentParticipantInDetailsModal) {
                        detailsModalTitle.textContent = `Details für ${currentParticipantInDetailsModal.name}`;
                        
                        // Split name for display/editing
                        const nameParts = currentParticipantInDetailsModal.name.split(' ');
                        const firstName = nameParts.shift() || '';
                        const lastName = nameParts.join(' ') || '';

                        // Set display values
                        detailsFirstNameDisplay.textContent = firstName;
                        detailsLastNameDisplay.textContent = lastName;
                        detailsStreetDisplay.textContent = currentParticipantInDetailsModal.street || 'N/A';
                        detailsCityDisplay.textContent = currentParticipantInDetailsModal.city || 'N/A';
                        detailsPhoneDisplay.textContent = currentParticipantInDetailsModal.phone || 'N/A';
                        detailsRegtypeDisplay.textContent = currentParticipantInDetailsModal.registrationType;
                        detailsPaidDisplay.textContent = currentParticipantInDetailsModal.paid ? 'Ja' : 'Nein';
                        detailsCanGoHomeAloneDisplay.textContent = currentParticipantInDetailsModal.canGoHomeAlone ? 'Ja' : 'Nein';

                        if (currentParticipantInDetailsModal.pickedUpBy) {
                            detailsPickedUpBy.textContent = currentParticipantInDetailsModal.pickedUpBy;
                            detailsPickedUpByRow.classList.remove('hidden');
                        } else {
                            detailsPickedUpBy.textContent = '';
                            detailsPickedUpByRow.classList.add('hidden');
                        }

                        // Set input values for editing
                        detailsFirstNameInput.value = firstName;
                        detailsLastNameInput.value = lastName;
                        detailsStreetInput.value = currentParticipantInDetailsModal.street;
                        detailsCityInput.value = currentParticipantInDetailsModal.city;
                        detailsPhoneInput.value = currentParticipantInDetailsModal.phone;
                        detailsRegtypeSelect.value = currentParticipantInDetailsModal.registrationType;
                        detailsPaidInput.checked = currentParticipantInDetailsModal.paid;
                        detailsCanGoHomeAloneInput.checked = currentParticipantInDetailsModal.canGoHomeAlone;

                        // Toggle edit mode based on user status
                        const isAdmin = (currentLoggedInUserStatus === 'admin');
                        setAdminEditMode(isAdmin);

                        // Populate activity history
                        detailsActivityHistory.innerHTML = ''; // Clear previous history
                        if (currentParticipantInDetailsModal.activityHistory && currentParticipantInDetailsModal.activityHistory.length > 0) {
                            currentParticipantInDetailsModal.activityHistory.forEach(entry => {
                                const li = document.createElement('li');
                                let text = `${entry.type} um ${entry.time}`;
                                if (entry.by) {
                                    text += ` durch ${entry.by}`;
                                }
                                if (entry.pickup && entry.pickup !== 'Alleine nach Hause') { // Only show pickup if not "alone"
                                    text += ` (Abholung: ${entry.pickup})`;
                                }
                                li.textContent = text;
                                detailsActivityHistory.appendChild(li);
                            });
                            noHistoryMessage.classList.add('hidden');
                        } else {
                            noHistoryMessage.classList.remove('hidden');
                        }

                        // Populate comments
                        detailsCommentsList.innerHTML = '';
                        if (currentParticipantInDetailsModal.comments && currentParticipantInDetailsModal.comments.length > 0) {
                            currentParticipantInDetailsModal.comments.forEach(comment => {
                                const p = document.createElement('p');
                                p.className = 'text-sm text-gray-700';
                                p.innerHTML = `<span class="font-semibold">${comment.by}</span> (${comment.timestamp}): ${comment.text}`;
                                detailsCommentsList.appendChild(p);
                            });
                            noCommentsMessage.classList.add('hidden');
                        } else {
                            noCommentsMessage.classList.remove('hidden');
                        }
                        newCommentText.value = ''; // Clear input field

                        participantDetailsModal.classList.remove('hidden');
                    }
                }
            });

            // Event-Listener für Schließen-Button des Details-Modals
            closeDetailsModalButton.addEventListener('click', () => {
                participantDetailsModal.classList.add('hidden');
                currentParticipantInDetailsModal = null; // Clear participant
            });

            // Event listener for saving participant details (Admin only)
            saveDetailsButton.addEventListener('click', () => {
                if (!currentParticipantInDetailsModal || currentLoggedInUserStatus !== 'admin') {
                    showAdminMessage(messageBox, "Berechtigung nicht ausreichend oder kein Teilnehmer ausgewählt.", true);
                    return;
                }

                const participantIndex = participants.findIndex(p => p.id === currentParticipantInDetailsModal.id);
                if (participantIndex === -1) {
                    showAdminMessage(messageBox, "Teilnehmer nicht gefunden.", true);
                    return;
                }

                // Update participant object with new values from input fields
                currentParticipantInDetailsModal.name = `${detailsFirstNameInput.value.trim()} ${detailsLastNameInput.value.trim()}`.trim();
                currentParticipantInDetailsModal.street = detailsStreetInput.value.trim();
                currentParticipantInDetailsModal.city = detailsCityInput.value.trim();
                currentParticipantInDetailsModal.phone = detailsPhoneInput.value.trim();
                currentParticipantInDetailsModal.registrationType = detailsRegtypeSelect.value;
                currentParticipantInDetailsModal.paid = detailsPaidInput.checked;
                currentParticipantInDetailsModal.canGoHomeAlone = detailsCanGoHomeAloneInput.checked;

                participants[participantIndex] = currentParticipantInDetailsModal;
                saveParticipantsToLocalStorage();
                showActionFeedback(`Details für "${currentParticipantInDetailsModal.name}" gespeichert!`, true);
                participantDetailsModal.classList.add('hidden'); // Close modal after saving
                currentParticipantInDetailsModal = null; // Clear participant
            });

            // Event listener for adding a comment
            addCommentButton.addEventListener('click', () => {
                const commentText = newCommentText.value.trim();
                if (!commentText || !currentParticipantInDetailsModal) {
                    // Using parentNode.querySelector because the message div might be dynamically added/hidden.
                    // A better approach would be to have a dedicated message div for the modal.
                    const messageDiv = addCommentButton.parentNode.querySelector('.modal-message-box'); // This div doesn't exist, will fallback to showActionFeedback
                    if (messageDiv) {
                        showAdminMessage(messageDiv, "Kommentarfeld darf nicht leer sein.", true);
                    } else {
                        console.error("No dedicated message box found for modal comments.");
                        showActionFeedback("Kommentarfeld darf nicht leer sein.", false);
                    }
                    return;
                }

                const newComment = {
                    text: commentText,
                    timestamp: new Date().toLocaleString('de-DE'),
                    by: currentLoggedInUsername || 'Unbekannt'
                };

                currentParticipantInDetailsModal.comments.push(newComment);
                saveParticipantsToLocalStorage(); // Save updated comments to local storage

                // Re-render comments in the modal
                const p = document.createElement('p');
                p.className = 'text-sm text-gray-700';
                p.innerHTML = `<span class="font-semibold">${newComment.by}</span> (${newComment.timestamp}): ${newComment.text}`;
                detailsCommentsList.appendChild(p);
                noCommentsMessage.classList.add('hidden');
                newCommentText.value = ''; // Clear input field

                showActionFeedback("Kommentar hinzugefügt!", true);
            });


            // Event listener for pickup person select change
            pickupPersonSelect.addEventListener('change', (event) => {
                if (event.target.value === 'Sonstige') {
                    customPickupPersonContainer.classList.remove('hidden');
                    customPickupPersonInput.focus();
                } else {
                    customPickupPersonContainer.classList.add('hidden');
                    customPickupPersonInput.value = '';
                }
                pickupMessageBox.classList.add('hidden');
            });

            // Event listener for pickup modal confirm button
            confirmPickupButton.addEventListener('click', () => {
                let pickupPerson = pickupPersonSelect.value;
                if (pickupPerson === 'Sonstige') {
                    pickupPerson = customPickupPersonInput.value.trim();
                    if (!pickupPerson) {
                        showPickupMessageBox("Bitte gib den Namen der abholenden Person an.", true);
                        return;
                    }
                } else if (!pickupPerson) {
                    showPickupMessageBox("Bitte wähle eine Abholperson aus.", true);
                    return;
                }

                if (currentParticipantBeingPickedUp) {
                    const participantIndex = participants.findIndex(p => p.id === currentParticipantBeingPickedUp.id);
                    if (participantIndex > -1) {
                        participants[participantIndex].status = 'available';
                        participants[participantIndex].savedStatus = 'available';
                        participants[participantIndex].pickedUpBy = pickupPerson;
                        const historyEntry = {
                            type: 'Abgemeldet',
                            time: new Date().toLocaleString('de-DE'),
                            by: currentLoggedInUsername || 'Unbekannt',
                            pickup: pickupPerson
                        };
                        participants[participantIndex].activityHistory.push(historyEntry); // Add to history
                        showActionFeedback(`Teilnehmer "${currentParticipantBeingPickedUp.name}" von "${pickupPerson}" abgemeldet.`, false);
                        saveParticipantsToLocalStorage();
                    }
                }
                pickupModal.classList.add('hidden'); // This line was being skipped due to the error
                currentParticipantBeingPickedUp = null;
            });

            // Event listener for pickup modal cancel button
            cancelPickupButton.addEventListener('click', () => {
                pickupModal.classList.add('hidden');
                currentParticipantBeingPickedUp = null;
                pickupMessageBox.classList.add('hidden');
            });


            // --- General Confirmation Modal Logic (reused for delete and new admin actions) ---
            let currentConfirmAction = null; // Stores the function to execute on confirmation

            function showConfirmationModal(title, message, confirmCallback) {
                deleteModalTitle.textContent = title;
                deleteModalMessage.innerHTML = message;
                deleteItemDisplay.textContent = ''; // Clear specific item display
                deleteModal.classList.remove('hidden');
                confirmDeleteButton.textContent = 'Bestätigen'; // Default text for confirmation
                confirmDeleteButton.classList.remove('bg-red-500', 'bg-orange-500', 'bg-yellow-500'); // Reset colors
                confirmDeleteButton.classList.add('bg-blue-500'); // Changed to blue

                // Set button text/color based on action type for clarity (now only text changes)
                if (title.includes('Löschen')) {
                    confirmDeleteButton.textContent = 'Löschen';
                } else if (title.includes('Entfernen')) {
                    confirmDeleteButton.textContent = 'Entfernen';
                } else if (title.includes('Zurücksetzen')) {
                    confirmDeleteButton.textContent = 'Zurücksetzen';
                }

                currentConfirmAction = confirmCallback;
            }

            cancelDeleteButton.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                currentConfirmAction = null;
                itemToDelete = null; // Clear if it was set
            });

            confirmDeleteButton.addEventListener('click', () => {
                if (currentConfirmAction) {
                    currentConfirmAction();
                }
                deleteModal.classList.add('hidden');
                currentConfirmAction = null;
                itemToDelete = null; // Clear if it was set
            });
            // --- END General Confirmation Modal Logic ---

            // Event-Listener zum Ändern des Benutzerstatus (Delegation für Benutzer)
            userListElement.addEventListener('click', (event) => {
                const target = event.target;
                const id = target.dataset.id;

                if (target.classList.contains('change-user-status-button')) {
                    const currentUserIndex = users.findIndex(u => u.id === id);
                    if (currentUserIndex > -1) {
                        const currentStatus = users[currentUserIndex].status;
                        users[currentUserIndex].status = currentStatus === 'admin' ? 'Betreuer' : 'admin';
                        saveUsers();
                        window.showMessage(`Status von Benutzer geändert zu "${users[currentUserIndex].status}".`, false);
                    }
                } else if (target.classList.contains('delete-item-button') && target.dataset.type === 'user') {
                    itemToDelete = {
                        type: 'user',
                        id: id,
                        name: target.dataset.username
                    };
                    showConfirmationModal(
                        'Benutzer löschen',
                        `Bist du sicher, dass du <span class="font-semibold">${itemToDelete.name}</span> löschen möchtest?`,
                        () => {
                            users = users.filter(user => user.id !== itemToDelete.id);
                            saveUsers();
                            window.showMessage(`Benutzer "${itemToDelete.name}" erfolgreich entfernt.`, false);
                        }
                    );
                }
            });

            // Event-Listener für den Abmelde-Button auf dem Hauptinhaltsbildschirm
            logoutButtonMain.addEventListener('click', () => {
                closeAllSwipedItems();
                // When logging out from main screen, ensure its list is re-rendered
                renderParticipantList();
                mainContentScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                enteredCode = '';
                updateCodeDisplay();
                currentLoggedInUsername = ''; // Clear username on logout
                currentLoggedInUserStatus = ''; // Clear user status on logout
                unifiedParticipantContainer.classList.add('hidden'); // Hide the unified list
                window.showMessage('Erfolgreich abgemeldet.', false);
            });

            // Event-Listener für Admin-Navigations-Buttons
            navUserManagementButton.addEventListener('click', () => showAdminSection('user-management-section'));
            navParticipantManagementButton.addEventListener('click', () => showAdminSection('participant-management-section'));
            navParticipantOverviewButton.addEventListener('click', () => showAdminSection('admin-participant-overview-section')); // NEW
            navProgramSettingsButton.addEventListener('click', () => showAdminSection('program-settings-section'));

            // Event-Listener für den Abmelde-Button auf dem Admin-Inhaltsbildschirm
            logoutButtonAdmin.addEventListener('click', () => {
                adminContentScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                enteredCode = '';
                updateCodeDisplay();
                currentLoggedInUsername = ''; // Clear username on logout
                currentLoggedInUserStatus = ''; // Clear user status on logout
                unifiedParticipantContainer.classList.add('hidden'); // Hide the unified list
                showAdminSection(''); // Ensure no section is open on next admin login
                window.showMessage('Erfolgreich abgemeldet.', false);
            });

            // NEW: Manuelle Teilnehmer hinzufügen
            addParticipantManualButton.addEventListener('click', () => {
                const firstName = newParticipantFirstNameInput.value.trim();
                const lastName = newParticipantLastNameInput.value.trim();
                const name = `${firstName} ${lastName}`.trim(); // Combine first and last name
                const regType = newParticipantRegtypeSelect.value;
                const street = newParticipantStreetInput.value.trim();
                const city = newParticipantCityInput.value.trim();
                const phone = newParticipantPhoneInput.value.trim(); // Get phone
                const paid = newParticipantPaidCheckbox.checked;
                const canGoHomeAlone = newParticipantCanGoHomeAloneCheckbox.checked;

                if (!firstName || !lastName || !street || !city || !phone) { // Validate all required fields
                    showAdminMessage(addParticipantManualMessage, "Bitte alle Felder ausfüllen (Vorname, Nachname, Straße, Ort, Tel.).", true);
                    return;
                }

                const newParticipant = {
                    id: Date.now().toString(),
                    name: name,
                    status: 'available', // New participants are always available initially
                    savedStatus: 'available',
                    registrationType: regType,
                    street: street,
                    city: city,
                    phone: phone, // Store phone
                    paid: paid,
                    canGoHomeAlone: canGoHomeAlone,
                    pickedUpBy: '',
                    activityHistory: [], // New participants start with empty history
                    comments: [] // NEW: Initialize comments array for new participants
                };

                // Check for duplicate participant by combined name
                const existingParticipant = participants.find(p => p.name.toLowerCase() === newParticipant.name.toLowerCase());
                if (existingParticipant) {
                    showAdminMessage(addParticipantManualMessage, `Teilnehmer "${name}" existiert bereits.`, true);
                    return;
                }

                participants.push(newParticipant);
                saveParticipantsToLocalStorage();
                showAdminMessage(addParticipantManualMessage, `Teilnehmer "${name}" erfolgreich hinzugefügt!`, false);

                // Clear form
                newParticipantFirstNameInput.value = '';
                newParticipantLastNameInput.value = '';
                newParticipantRegtypeSelect.value = 'Tagesanmeldung';
                newParticipantStreetInput.value = '';
                newParticipantCityInput.value = '';
                newParticipantPhoneInput.value = ''; // Clear phone input
                newParticipantPaidCheckbox.checked = false;
                newParticipantCanGoHomeAloneCheckbox.checked = false;
            });

            // Excel (.xlsx) Import using SheetJS
            importParticipantsButton.addEventListener('click', () => {
                const file = importParticipantsFileInput.files[0];
                if (!file) {
                    showAdminMessage(importParticipantsMessage, "Bitte wähle eine Excel-Datei (.xlsx oder .xls) aus.", true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });

                        // Assuming the first sheet contains the data
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        // Convert sheet to JSON, including header
                        const jsonRows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                        if (jsonRows.length === 0) {
                            showAdminMessage(importParticipantsMessage, "Excel-Datei ist leer oder ungültig.", true);
                            return;
                        }

                        const header = jsonRows[0].map(h => h.trim());
                        // Define expected headers for mapping (updated to include Anmeldeart)
                        const expectedHeader = ['Name', 'Vorname', 'Straße', 'Ort', 'Tel.', 'Darf alleine nach Hause?', 'Bezahlt?', 'Anmeldeart'];
                        
                        // Validate headers - now stricter, requires all specified headers
                        const hasAllRequiredHeaders = ['Name', 'Vorname', 'Straße', 'Ort', 'Tel.', 'Darf alleine nach Hause?', 'Bezahlt?'].every(h => header.includes(h));
                        if (!hasAllRequiredHeaders) {
                            showAdminMessage(importParticipantsMessage, `Ungültiges Excel-Header-Format. Erwartete Pflichtfelder: Name,Vorname,Straße,Ort,Tel.,Darf alleine nach Hause?,Bezahlt?`, true);
                            return;
                        }

                        const regTypeColumnIndex = header.indexOf('Anmeldeart');
                        const hasRegTypeColumn = regTypeColumnIndex !== -1;

                        let importedCount = 0;
                        for (let i = 1; i < jsonRows.length; i++) {
                            const values = jsonRows[i];
                            if (values.length >= (expectedHeader.length - (hasRegTypeColumn ? 0 : 1))) { // Adjust required columns based on optional Anmeldeart
                                const registrationType = hasRegTypeColumn && values[regTypeColumnIndex] && ['Tagesanmeldung', 'Wochenanmeldung'].includes(String(values[regTypeColumnIndex]).trim())
                                    ? String(values[regTypeColumnIndex]).trim()
                                    : 'Wochenanmeldung'; // Default to Wochenanmeldung if column missing or invalid value


                                const newParticipant = {
                                    id: Date.now().toString() + '-' + i, // Unique ID for imported participants
                                    // Combine Vorname and Name (Nachname) from Excel
                                    name: `${values[header.indexOf('Vorname')]} ${values[header.indexOf('Name')]}`.trim(), 
                                    status: 'available',
                                    savedStatus: 'available',
                                    registrationType: registrationType, // Use determined registration type
                                    street: values[header.indexOf('Straße')] || '',
                                    city: values[header.indexOf('Ort')] || '',
                                    phone: values[header.indexOf('Tel.')] ? String(values[header.indexOf('Tel.')]).trim() : '', // Ensure phone is string
                                    // Convert 'Ja'/'Nein' or 'TRUE'/'FALSE' to boolean, case-insensitive
                                    paid: (String(values[header.indexOf('Bezahlt?')]).toLowerCase() === 'ja' || String(values[header.indexOf('Bezahlt?')]).toLowerCase() === 'true'),
                                    canGoHomeAlone: (String(values[header.indexOf('Darf alleine nach Hause?')]).toLowerCase() === 'ja' || String(values[header.indexOf('Darf alleine nach Hause?')]).toLowerCase() === 'true'),
                                    pickedUpBy: '',
                                    activityHistory: [],
                                    comments: [] // NEW: Initialize comments for imported participants
                                };

                                // Check for duplicate participant by combined name
                                const existingParticipant = participants.find(p => p.name.toLowerCase() === newParticipant.name.toLowerCase());
                                if (existingParticipant) {
                                    console.warn(`Skipping duplicate participant (by name): ${newParticipant.name}`);
                                    continue;
                                }

                                participants.push(newParticipant);
                                importedCount++;
                            } else {
                                console.warn(`Skipping malformed row (incorrect number of columns or missing data): ${JSON.stringify(values)}`);
                            }
                        }

                        if (importedCount > 0) {
                            saveParticipantsToLocalStorage();
                            showAdminMessage(importParticipantsMessage, `${importedCount} Teilnehmer erfolgreich importiert!`, false);
                            importParticipantsFileInput.value = ''; // Clear file input
                        } else {
                            showAdminMessage(importParticipantsMessage, "Keine gültigen Teilnehmer zum Importieren gefunden oder alle existierten bereits.", true);
                        }

                    } catch (error) {
                        console.error("Error parsing Excel file:", error);
                        showAdminMessage(importParticipantsMessage, "Fehler beim Lesen der Excel-Datei. Stelle sicher, dass sie korrekt formatiert ist.", true);
                    }
                };

                reader.onerror = () => {
                    showAdminMessage(importParticipantsMessage, "Fehler beim Lesen der Datei.", true);
                };

                // Read the file as an ArrayBuffer for SheetJS
                reader.readAsArrayBuffer(file);
            });

            // Event listener for control mode toggle
            controlModeToggle.addEventListener('change', () => {
                controlModeActive = controlModeToggle.checked;
                saveControlMode(); // Save control mode state
                renderParticipantList(); // Re-render to apply new styling
                if (controlModeActive) {
                    showAdminMessage(importParticipantsMessage, "Kontrollmodus aktiviert: Unbezahlte Teilnehmer sind rot.", false);
                } else {
                    showAdminMessage(importParticipantsMessage, "Kontrollmodus deaktiviert.", false);
                }
            });

            // NEW: Event listeners for program settings buttons
            removeAllParticipantsButton.addEventListener('click', () => {
                showConfirmationModal(
                    'Alle Teilnehmer löschen',
                    'Bist du sicher, dass du **ALLE TEILNEHMER** entfernen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!',
                    () => {
                        participants = [];
                        saveParticipantsToLocalStorage();
                        showAdminMessage(importParticipantsMessage, "Alle Teilnehmer erfolgreich entfernt.", false);
                    }
                );
            });

            removeDailyParticipantsButton.addEventListener('click', () => {
                showConfirmationModal(
                    'Tagesanmeldungen entfernen',
                    'Bist du sicher, dass du **ALLE TAGESANMELDUNGEN** entfernen möchtest? Diese Aktion kann nicht rückgängig gemacht werden!',
                    () => {
                        participants = participants.filter(p => p.registrationType !== 'Tagesanmeldung');
                        saveParticipantsToLocalStorage();
                        showAdminMessage(importParticipantsMessage, "Alle Tagesanmeldungen erfolgreich entfernt.", false);
                    }
                );
            });

            resetAllParticipantsButton.addEventListener('click', () => {
                showConfirmationModal(
                    'Alle Daten zurücksetzen',
                    'Bist du sicher, dass du den **Status und alle Aktivitäten/Kommentare** der Teilnehmer zurücksetzen möchtest? Dies kann nicht rückgängig gemacht werden!',
                    () => {
                        participants.forEach(p => {
                            p.status = 'available';
                            p.savedStatus = 'available';
                            p.pickedUpBy = '';
                            p.activityHistory = [];
                            p.comments = [];
                        });
                        saveParticipantsToLocalStorage();
                        showAdminMessage(importParticipantsMessage, "Alle Teilnehmerdaten erfolgreich zurückgesetzt.", false);
                    }
                );
            });

            // Event listener for search input
            participantSearchInput.addEventListener('input', () => {
                renderParticipantList();
            });


            // Initialisierung
            loadUsers();
            loadParticipants();
            loadControlMode(); // Load control mode state on app start
            updateCodeDisplay();
            renderUserList();
            // Do not call renderParticipantList here, it will be called when the correct screen is shown (Betreuer or Admin Overview)
        </script>
        <script>
            // Zusätzliche Tailwind CSS-Klassen für Tastenfeld-Buttons für konsistentes Styling
            document.querySelectorAll('.keypad-button').forEach(button => {
                button.classList.add('bg-gray-200', 'hover:bg-gray-300', 'active:bg-gray-400', 'text-gray-800', 'font-semibold', 'py-4', 'px-6', 'rounded-lg', 'shadow-md', 'transition-all', 'duration-200', 'text-2xl');
            });
        </script>
    </body>
</html>        }
        .admin-nav-button:not(.active):hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        /* Active state */
        .admin-nav-button.active {
            background-color: #2563eb; /* bg-blue-600 */
            color: #ffffff; /* text-white */
        }
        .admin-nav-button.active:hover {
            background-color: #1d4ed8; /* hover:bg-blue-700 */
        }

        /* Swipe-to-Reveal styles */
        .participant-item-container {
            position: relative;
            overflow: hidden; /* Hide the button initially */
            background-color: #fff;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            margin-bottom: 0.5rem; /* spacing between items */
            cursor: grab; /* Indicates draggable nature */
        }
        .participant-item-container:active {
             cursor: grabbing;
        }

        .participant-content-wrapper {
            padding: 0.75rem 1rem; /* py-3 px-4 equivalent */
            background-color: #fff; /* Ensure it covers the button */
            position: relative;
            z-index: 10;
            transition: transform 0.3s ease-out; /* Smooth slide */
            touch-action: pan-y; /* Allow vertical scrolling, prevent horizontal by default */
        }

        .participant-action-button-container {
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0; /* Button is always on the right */
            width: 100%; /* Take full width to simplify positioning */
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Align button to the right */
            transform: translateX(100%); /* Initially fully off-screen to the right */
            transition: transform 0.3s ease-out; /* Smooth slide */
            z-index: 5;
            padding-right: 1rem; /* Adjust padding for button */
        }

        /* When swiped, reveal the button and slide content */
        .participant-item-container.swiped .participant-action-button-container {
            transform: translateX(0); /* Button moves to cover the full width */
        }
        .participant-item-container.swiped .participant-content-wrapper {
             transform: translateX(-120px); /* Adjusted to reveal more of the button */
        }

        .participant-action-button {
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            padding: 0.5rem 1rem; /* py-2 px-4 */
            white-space: nowrap; /* Prevent text wrapping */
        }

        /* Specific colors for action buttons */
        .participant-action-button.anmelden-button {
            background-color: #34d399; /* Tailwind green-500 */
            color: #ffffff;
            font-size: 0.875rem; /* text-sm */
        }
        .participant-action-button.abmelden-button {
            background-color: #ef4444; /* Tailwind red-500 */
            color: #ffffff;
            font-size: 0.875rem; /* text-sm */
        }

        /* Status dot styling */
        .status-dot {
            display: inline-block;
            width: 0.75rem; /* w-3 */
            height: 0.75rem; /* h-3 */
            border-radius: 9999px; /* rounded-full */
            flex-shrink: 0; /* Prevent it from shrinking */
            margin-right: 0.5rem; /* Space between dot and name */
        }
        /* Specific colors for status dots */
        .status-dot.anwesend {
            background-color: #10b981; /* green-500 */
        }
        .status-dot.abwesend {
            background-color: #ef4444; /* red-500 */
        }
        .status-dot.initial {
            background-color: #9ca3af; /* gray-400 */
        }


        /* Success message animation */
        #action-feedback-message {
            transform: translateY(-100%);
            opacity: 0;
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
        }
        #action-feedback-message.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Info icon style */
        .info-icon {
            font-weight: bold;
            cursor: pointer;
            color: #60a5fa; /* Blue-400 */
            margin-left: 0.5rem;
            font-size: 1.1em;
            transition: color 0.2s ease-in-out;
        }
        .info-icon:hover {
            color: #3b82f6; /* Blue-500 */
        }

        /* NEW: Comment icon style */
        .comment-icon {
            background-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
            border-radius: 50%;
            width: 1.5em; /* Adjust size as needed */
            height: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 0.5rem;
            flex-shrink: 0;
            cursor: help; /* Indicate it's informational */
        }
        
        /* Modale am oberen Rand anzeigen */
        #pickup-modal.at-top {
            align-items: flex-start;
            padding-top: 2rem;
        }

        /* Alphabet-Filter-Styles (for dropdowns) */
        .filter-dropdown-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center; /* Align items vertically */
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .filter-dropdown-container label {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            color: #4b5563;
        }
        .filter-dropdown-container select {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
            font-size: 0.875rem; /* text-sm */
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-dropdown-container select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        /* Added for keypad buttons */
        .keypad-button {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-800 */
            font-weight: 600; /* font-semibold */
            padding: 1rem 1.5rem; /* py-4 px-6 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            transition: all 0.2s ease-in-out; /* transition-all duration-200 */
            font-size: 1.5rem; /* text-2xl */
        }
        .keypad-button:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }
        .keypad-button:active {
            background-color: #9ca3af; /* active:bg-gray-400 */
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06); /* inset shadow */
        }
    </style>
</head>
<body class="antialiased">
    <div id="app-container" class="bg-white rounded-xl shadow-lg p-6 w-full max-w-4xl mx-auto transform transition-all duration-300">
        <!-- Login Screen -->
        <div id="login-screen" class="space-y-6">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm</h1>
            <p class="text-center text-gray-600 mb-8">Bitte gib den Zugangscode ein.</p>

            <!-- Inner container for login screen content to keep it compact -->
            <div class="max-w-md mx-auto">
                <!-- Code Display -->
                <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center text-3xl font-semibold tracking-wider text-gray-800 mb-6 shadow-inner">
                    <span id="code-display"></span><span id="cursor" class="animate-pulse">|</span>
                </div>

                <!-- Keypad -->
                <div class="grid grid-cols-3 gap-4">
                    <!-- Numbers -->
                    <button class="keypad-button" data-value="1">1</button>
                    <button class="keypad-button" data-value="2">2</button>
                    <button class="keypad-button" data-value="3">3</button>
                    <button class="keypad-button" data-value="4">4</button>
                    <button class="keypad-button" data-value="5">5</button>
                    <button class="keypad-button" data-value="6">6</button>
                    <button class="keypad-button" data-value="7">7</button>
                    <button class="keypad-button" data-value="8">8</button>
                    <button class="keypad-button" data-value="9">9</button>
                    <!-- Backspace and 0 -->
                    <button class="keypad-button bg-red-500 hover:bg-red-600 active:bg-red-700 text-white" data-action="clear">⌫</button>
                    <button class="keypad-button" data-value="0">0</button>
                    <button class="keypad-button bg-green-500 hover:bg-green-600 active:bg-green-700 text-white" data-action="enter">✓</button>
                </div>

                <!-- Message Box for errors -->
                <div id="message-box" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden text-center" role="alert">
                    <!-- Error message will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Main Content Screen (for Betreuer - initially hidden) -->
        <div id="main-content-screen" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm An-/Abmeldung (Betreuer)</h2>
            <p class="text-center text-gray-600 mb-8">
                Willkommen, <span id="betreuer-name-display"></span>! <span id="instruction-toggle-text" class="text-blue-600 cursor-pointer hover:underline">für weitere Instruktionen hier klicken</span>
                <span id="full-instructions" class="hidden">Wische auf einem Teilnehmer nach links, um den An-/Abmelde-Button zu enthüllen. Klicke auf den Button, um Teilnehmer an oder abzumelden. Unter dem Infobutton kannst du Details einsehen und Kommentare erstellen. Sobald ein Kommentar bei einem Teilnehmer hinterlegt ist, findet sich ein (C) vor dem Infobutton. **Die Änderungen werden automatisch gespeichert.**</span>
            </p>

            <!-- Action feedback message from top -->
            <div id="action-feedback-message" class="fixed top-0 left-0 w-full bg-green-500 text-white text-center py-3 transform -translate-y-full transition-all duration-500 ease-out z-50 shadow-lg">
                <!-- Message will be set by JS -->
            </div>

            <!-- The unified-participant-container content will be displayed here dynamically for Betreuer -->
            <!-- The actual unified-participant-container element is placed outside this div for shared use -->

            <button id="logout-button-main" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 active:bg-gray-500 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                Abmelden
            </button>
        </div>

        <!-- Admin Content Screen (new, initially hidden) -->
        <div id="admin-content-screen" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Ferienprogramm Admin-Bereich</h2>
            <p class="text-center text-gray-600 mb-8">
                Willkommen im Admin-Bereich! Hier können Administratoren umfassende Einstellungen vornehmen.
            </p>

            <!-- Admin Navigation/Menu Band -->
            <div class="flex flex-col space-y-2 mb-6"> <!-- Changed to flex-col for vertical stacking -->
                <button id="nav-user-management" class="admin-nav-button">Benutzerverwaltung</button> <!-- Removed active class -->
                <button id="nav-participant-management" class="admin-nav-button">Teilnehmerverwaltung</button>
                <button id="nav-participant-overview" class="admin-nav-button">Teilnehmerübersicht</button>
                <button id="nav-program-settings" class="admin-nav-button">Programmeinstellungen</button>
            </div>

            <!-- Section Containers -->
            <div id="admin-section-wrapper" class="hidden"> <!-- Initially hidden -->
                <p id="admin-welcome-message" class="text-center text-gray-600 mb-4">Bitte wählen Sie eine der Optionen oben.</p> <!-- New message -->

                <div id="user-management-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Benutzerverwaltung</h3>

                    <!-- Add User Form -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Neuen Benutzer hinzufügen</h4>
                        <input type="text" id="new-username" placeholder="Benutzername" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-user-code" placeholder="Zugangscode (z.B. 1234)" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-user-status" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Betreuer">Betreuer</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button id="add-user-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-full transition-all duration-200">Benutzer hinzufügen</button>
                        <div id="add-user-message" class="mt-2 text-sm text-center hidden"></div>
                    </div>

                    <!-- User List -->
                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Aktuelle Benutzer</h4>
                        <ul id="user-list" class="space-y-3">
                            <li id="no-users-message" class="text-center text-gray-500">Lade Benutzer...</li>
                        </ul>
                    </div>
                </div>

                <!-- Participant Management Section (NEW) -->
                <div id="participant-management-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Teilnehmerverwaltung</h3>

                    <!-- Add Participant Manually Form -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Neuen Teilnehmer manuell hinzufügen</h4>
                        <input type="text" id="new-participant-first-name" placeholder="Vorname" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-last-name" placeholder="Nachname" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-participant-regtype" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Tagesanmeldung">Tagesanmeldung</option>
                            <option value="Wochenanmeldung">Wochenanmeldung</option>
                        </select>
                        <input type="text" id="new-participant-street" placeholder="Straße" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-city" placeholder="Ort" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-participant-phone" placeholder="Tel." class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="new-participant-paid" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="new-participant-paid" class="ml-2 block text-sm text-gray-900">Bezahlt</label>
                        </div>
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="new-participant-can-go-home-alone" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="new-participant-can-go-home-alone" class="ml-2 block text-sm text-gray-900">Darf alleine nach Hause</label>
                        </div>
                        <div class="flex space-x-2 w-full">
                            <button id="add-participant-manual-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg w-1/2 transition-all duration-200">Teilnehmer hinzufügen</button>
                            <button id="add-and-register-participant-button" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg w-1/2 transition-all duration-200">Hinzufügen & Anmelden</button>
                        </div>
                        <div id="add-participant-manual-message" class="mt-2 text-sm text-center hidden"></div>
                    </div>

                    <!-- Import Participants from Excel -->
                    <div class="mb-6 border-b pb-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Teilnehmer aus Excel importieren</h4>
                        <input type="file" id="import-participants-file-input" accept=".xlsx,.xls" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="import-participants-button" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg w-full transition-all duration-200">Excel importieren</button>
                        <div id="import-participants-message" class="mt-2 text-sm text-center hidden"></div>
                        <p class="text-xs text-gray-500 mt-2">Erwartetes Excel-Format (erste Zeile als Überschrift): Name,Vorname,Straße,Ort,Tel.,Darf alleine nach Hause?,Bezahlt?,**Anmeldeart** (optional: Tagesanmeldung/Wochenanmeldung). Beispiel: Mustermann,Max,Musterstr. 1,Musterstadt,0123456789,Nein,Ja,Tagesanmeldung</p>
                    </div>
                </div>

                <!-- NEW: Admin Participant Overview Section -->
                <div id="admin-participant-overview-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Teilnehmerübersicht</h3>
                    <p class="text-gray-600 mb-4">Hier siehst du alle Teilnehmer und ihren aktuellen Status.</p>
                    <!-- The unified-participant-container content will be displayed here dynamically -->
                </div>

                <!-- Program Settings Section -->
                <div id="program-settings-section" class="bg-gray-100 rounded-lg p-4 shadow-md hidden">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Programmeinstellungen</h3>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="control-mode-toggle" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="control-mode-toggle" class="ml-2 block text-sm text-gray-900">Kontrollmodus aktivieren (unbezahlte Teilnehmer rot hervorheben)</label>
                    </div>

                    <div class="space-y-3 mt-6 border-t pt-4">
                        <h4 class="text-lg font-medium text-gray-700 mb-3">Datenverwaltung</h4>
                        <button id="remove-all-participants-button" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Alle Teilnehmer entfernen
                        </button>
                        <button id="remove-daily-participants-button" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Alle Tagesanmeldungen entfernen
                        </button>
                        <button id="reset-all-participants-button" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200">
                            Status und Daten zurücksetzen
                        </button>
                    </div>
                </div>
            </div> <!-- End admin-section-wrapper -->

            <button id="logout-button-admin" class="mt-6 w-full bg-gray-300 hover:bg-gray-400 active:bg-gray-500 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                Abmelden
            </button>
        </div>

        <!-- Unified Participant List Container - Moved to be a direct child of app-container, hidden by default -->
        <!-- This container will be toggled visible/hidden based on active screen/admin tab -->
        <div id="unified-participant-container" class="min-h-[200px] space-y-2 mt-6 hidden">
            <!-- Count of present participants -->
            <p id="present-participants-count" class="text-center text-gray-600 mb-2 font-semibold"></p>

            <!-- Search Input -->
            <input type="text" id="participant-search-input" placeholder="Teilnehmer suchen..." class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <!-- Alphabetical Filters for First and Last Names (Dropdowns) and "Show All" Button -->
            <div class="filter-dropdown-container">
                <label for="filter-first-name-select">Vorname:</label>
                <select id="filter-first-name-select" class="p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Options will be generated by JS -->
                </select>
                <label for="filter-last-name-select">Nachname:</label>
                <select id="filter-last-name-select" class="p-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Options will be generated by JS -->
                </select>
                <button id="show-all-participants-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-200">
                    Alle Teilnehmer anzeigen
                </button>
            </div>
            
            <ul id="unified-participant-list" class="space-y-2">
                <!-- All participants will be rendered here -->
            </ul>
            <p id="no-participants-message-unified" class="text-center text-gray-500 text-sm mt-4 hidden">Noch keine Teilnehmer vorhanden.</p>
        </div>

        <!-- Delete Confirmation Modal (Reused for other confirmations) -->
        <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 id="delete-modal-title" class="text-xl font-bold mb-4">Bestätigung</h3>
                <p id="delete-modal-message" class="mb-6">Bist du sicher, dass du <span id="delete-item-display" class="font-semibold"></span> löschen möchtest?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                    <button id="confirm-delete" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Bestätigen</button> <!-- Changed to blue -->
                </div>
            </div>
        </div>

        <!-- Participant Details Modal -->
        <div id="participant-details-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 id="details-modal-title" class="text-xl font-bold mb-4 text-gray-800">Teilnehmerdetails</h3>
                <div id="details-content-scrollable" class="max-h-[70vh] overflow-y-auto pr-2"> <!-- Added for scrolling -->
                    <div class="space-y-3 text-gray-700">
                        <!-- Editable Name Fields -->
                        <p>
                            <strong>Vorname:</strong>
                            <span id="details-first-name-display"></span>
                            <input type="text" id="details-first-name-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Nachname:</strong>
                            <span id="details-last-name-display"></span>
                            <input type="text" id="details-last-name-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        
                        <!-- Editable Text Fields -->
                        <p>
                            <strong>Straße:</strong>
                            <span id="details-street-display"></span>
                            <input type="text" id="details-street-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Ort:</strong>
                            <span id="details-city-display"></span>
                            <input type="text" id="details-city-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Tel.:</strong>
                            <span id="details-phone-display"></span>
                            <input type="text" id="details-phone-input" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </p>
                        <p>
                            <strong>Anmeldungstyp:</strong>
                            <span id="details-regtype-display"></span>
                            <select id="details-regtype-select" class="w-full p-1 border border-gray-300 rounded-md hidden focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Tagesanmeldung">Tagesanmeldung</option>
                                <option value="Wochenanmeldung">Wochenanmeldung</option>
                            </select>
                        </p>

                        <!-- Editable Checkboxes -->
                        <div class="flex items-center">
                            <strong>Bezahlt:</strong>
                            <span id="details-paid-display" class="ml-2"></span>
                            <input type="checkbox" id="details-paid-input" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ml-2 hidden">
                        </div>
                        <div class="flex items-center">
                            <strong>Darf alleine nach Hause:</strong>
                            <span id="details-can-go-home-alone-display" class="ml-2"></span>
                            <input type="checkbox" id="details-can-go-home-alone-input" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 ml-2 hidden">
                        </div>
                        
                        <p id="details-picked-up-by-row" class="hidden"><strong>Abgeholt von:</strong> <span id="details-picked-up-by"></span></p>
                    </div>

                    <!-- Comment Section -->
                    <div id="details-comment-section" class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Kommentare</h4>
                        <div id="details-comments-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto border p-2 rounded bg-gray-50">
                            <!-- Comments will be populated here -->
                            <p class="text-gray-500 text-sm italic" id="no-comments-message">Noch keine Kommentare vorhanden.</p>
                        </div>
                        <textarea id="new-comment-text" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Neuen Kommentar hinzufügen..."></textarea>
                        <button id="add-comment-button" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-all duration-200">Kommentar hinzufügen</button>
                    </div>

                    <!-- Activity History Section -->
                    <div id="details-activity-history-container" class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-lg font-bold mb-2 text-gray-800">Aktivitäten</h4>
                        <ul id="details-activity-history" class="space-y-1 text-sm">
                            <!-- History entries will be populated here -->
                        </ul>
                        <p id="no-history-message" class="text-gray-500 text-sm hidden">Keine Aktivitäten vorhanden.</p>
                    </div>
                </div> <!-- End of details-content-scrollable -->
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="save-details-button" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hidden">Speichern</button>
                    <button id="close-details-modal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Schließen</button>
                </div>
            </div>
        </div>

        <!-- Pickup Confirmation Modal -->
        <div id="pickup-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center at-top hidden z-50">
            <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm">
                <h3 class="text-xl font-bold mb-4 text-gray-800">Teilnehmer abholen</h3>
                <p class="mb-4">Bitte bestätige, wer <span id="pickup-participant-name" class="font-semibold"></span> abgeholt hat:</p>
                
                <div class="space-y-3 mb-6">
                    <div>
                        <label for="pickup-person-select" class="block text-sm font-medium text-gray-700 mb-1">Abholperson auswählen:</label>
                        <select id="pickup-person-select" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Bitte auswählen</option>
                            <option value="Mutter">Mutter</option>
                            <option value="Vater">Vater</option>
                            <option value="Oma">Oma</option>
                            <option value="Opa">Opa</option>
                            <option value="Geschwister">Geschwister</option>
                            <option value="Sonstige">Sonstige (bitte angeben)</option>
                        </select>
                    </div>
                    <div id="custom-pickup-person-container" class="hidden">
                        <label for="custom-pickup-person-input" class="block text-sm font-medium text-gray-700 mb-1">Name der abholenden Person:</label>
                        <input type="text" id="custom-pickup-person-input" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Name der abholenden Person">
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button id="cancel-pickup" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">Abbrechen</button>
                    <button id="confirm-pickup" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">Bestätigen</button>
                </div>
                <div id="pickup-message-box" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden text-center" role="alert"></div>
            </div>
        </div>

        <script>
            // DOM elements
            const loginScreen = document.getElementById('login-screen');
            const mainContentScreen = document.getElementById('main-content-screen');
            const adminContentScreen = document.getElementById('admin-content-screen');
            const codeDisplay = document.getElementById('code-display');
            const keypadButtons = document.querySelectorAll('.keypad-button');
            const logoutButtonMain = document.getElementById('logout-button-main');
            const logoutButtonAdmin = document.getElementById('logout-button-admin');
            const messageBox = document.getElementById('message-box');
            const betreuerNameDisplay = document.getElementById('betreuer-name-display'); // New element for Betreuer name
            const instructionToggleText = document.getElementById('instruction-toggle-text'); // NEW
            const fullInstructions = document.getElementById('full-instructions'); // NEW

            // Admin User Management Elements
            const newUsernameInput = document.getElementById('new-username');
            const newUserCodeInput = document.getElementById('new-user-code');
            const newUserStatusSelect = document.getElementById('new-user-status');
            const addUserButton = document.getElementById('add-user-button');
            const addUserMessage = document.getElementById('add-user-message');
            const userListElement = document.getElementById('user-list');
            const noUsersMessage = document.getElementById('no-users-message');

            // Participant List Elements (shared between Betreuer and Admin Overview)
            const unifiedParticipantContainer = document.getElementById('unified-participant-container');
            const unifiedParticipantList = document.getElementById('unified-participant-list');
            const noParticipantsMessageUnified = document.getElementById('no-participants-message-unified');
            const actionFeedbackMessage = document.getElementById('action-feedback-message');
            const participantActionsDiv = document.getElementById('participant-actions'); // This div is now always hidden
            const participantSearchInput = document.getElementById('participant-search-input'); // NEW
            const presentParticipantsCount = document.getElementById('present-participants-count'); // NEW

            const deleteModal = document.getElementById('delete-modal');
            const deleteModalTitle = document.getElementById('delete-modal-title'); // NEW
            const deleteModalMessage = document.getElementById('delete-modal-message'); // NEW
            const deleteItemDisplay = document.getElementById('delete-item-display');
            const cancelDeleteButton = document.getElementById('cancel-delete');
            const confirmDeleteButton = document.getElementById('confirm-delete');

            // Participant Details Modal Elements
            const participantDetailsModal = document.getElementById('participant-details-modal');
            const detailsModalTitle = document.getElementById('details-modal-title');
            
            // Detail display spans
            const detailsFirstNameDisplay = document.getElementById('details-first-name-display');
            const detailsLastNameDisplay = document.getElementById('details-last-name-display');
            const detailsStreetDisplay = document.getElementById('details-street-display');
            const detailsCityDisplay = document.getElementById('details-city-display');
            const detailsPhoneDisplay = document.getElementById('details-phone-display');
            const detailsRegtypeDisplay = document.getElementById('details-regtype-display');
            const detailsPaidDisplay = document.getElementById('details-paid-display');
            const detailsCanGoHomeAloneDisplay = document.getElementById('details-can-go-home-alone-display');

            // Detail input fields (for admin editing)
            const detailsFirstNameInput = document.getElementById('details-first-name-input');
            const detailsLastNameInput = document.getElementById('details-last-name-input');
            const detailsStreetInput = document.getElementById('details-street-input');
            const detailsCityInput = document.getElementById('details-city-input');
            const detailsPhoneInput = document.getElementById('details-phone-input');
            const detailsRegtypeSelect = document.getElementById('details-regtype-select');
            const detailsPaidInput = document.getElementById('details-paid-input');
            const detailsCanGoHomeAloneInput = document.getElementById('details-can-go-home-alone-input');

            const detailsPickedUpBy = document.getElementById('details-picked-up-by');
            const detailsPickedUpByRow = document.getElementById('details-picked-up-by-row');
            const closeDetailsModalButton = document.getElementById('close-details-modal');
            const saveDetailsButton = document.getElementById('save-details-button'); // New save button for details

            const detailsActivityHistory = document.getElementById('details-activity-history'); // New element
            const noHistoryMessage = document.getElementById('no-history-message'); // New element

            // Comment Section Elements
            const detailsCommentSection = document.getElementById('details-comment-section');
            const detailsCommentsList = document.getElementById('details-comments-list');
            const newCommentText = document.getElementById('new-comment-text');
            const addCommentButton = document.getElementById('add-comment-button');
            const noCommentsMessage = document.getElementById('no-comments-message');


            // Pickup Confirmation Modal Elements
            const pickupModal = document.getElementById('pickup-modal');
            const pickupParticipantName = document.getElementById('pickup-participant-name');
            const pickupPersonSelect = document.getElementById('pickup-person-select');
            const customPickupPersonContainer = document.getElementById('custom-pickup-person-container');
            const customPickupPersonInput = document.getElementById('custom-pickup-person-input');
            const cancelPickupButton = document.getElementById('cancel-pickup');
            const confirmPickupButton = document.getElementById('confirm-pickup');
            const pickupMessageBox = document.getElementById('pickup-message-box');

            // Admin Participant Management Elements
            const navParticipantManagementButton = document.getElementById('nav-participant-management');
            const participantManagementSection = document.getElementById('participant-management-section');
            const newParticipantFirstNameInput = document.getElementById('new-participant-first-name');
            const newParticipantLastNameInput = document.getElementById('new-participant-last-name');
            const newParticipantRegtypeSelect = document.getElementById('new-participant-regtype');
            const newParticipantStreetInput = document.getElementById('new-participant-street');
            const newParticipantCityInput = document.getElementById('new-participant-city');
            const newParticipantPhoneInput = document.getElementById('new-participant-phone');
            const newParticipantPaidCheckbox = document.getElementById('new-participant-paid');
            const newParticipantCanGoHomeAloneCheckbox = document.getElementById('new-participant-can-go-home-alone');
            const addParticipantManualButton = document.getElementById('add-participant-manual-button');
            const addAndRegisterParticipantButton = document.getElementById('add-and-register-participant-button'); // NEW button
            const addParticipantManualMessage = document.getElementById('add-participant-manual-message');
            const importParticipantsFileInput = document.getElementById('import-participants-file-input');
            const importParticipantsButton = document.getElementById('import-participants-button');
            const importParticipantsMessage = document.getElementById('import-participants-message');

            // Admin Program Settings elements
            const controlModeToggle = document.getElementById('control-mode-toggle');
            const removeAllParticipantsButton = document.getElementById('remove-all-participants-button'); // NEW
            const removeDailyParticipantsButton = document.getElementById('remove-daily-participants-button'); // NEW
            const resetAllParticipantsButton = document.getElementById('reset-all-participants-button'); // NEW

            // NEW: Admin Participant Overview elements
            const navParticipantOverviewButton = document.getElementById('nav-participant-overview');
            const adminParticipantOverviewSection = document.getElementById('admin-participant-overview-section');


            // Admin Navigation elements
            const navUserManagementButton = document.getElementById('nav-user-management');
            const navProgramSettingsButton = document.getElementById('nav-program-settings');
            const userManagementSection = document.getElementById('user-management-section');
            const programSettingsSection = document.getElementById('program-settings-section');
            const adminNavButtons = document.querySelectorAll('.admin-nav-button');
            const adminSectionWrapper = document.getElementById('admin-section-wrapper'); // NEW
            const adminWelcomeMessage = document.getElementById('admin-welcome-message'); // NEW

            // Alphabetical filter elements (Dropdowns)
            const filterFirstNameSelect = document.getElementById('filter-first-name-select');
            const filterLastNameSelect = document.getElementById('filter-last-name-select');
            const showAllParticipantsButton = document.getElementById('show-all-participants-button'); // NEW

            // Geänderte Variablen von 'let' zu 'var', um "SyntaxError: Cannot declare a let variable twice" zu vermeiden
            var enteredCode = '';
            var itemToDelete = null; // Reused for general confirmations
            var activeSwipeItem = null; // Refers to the participant-content-wrapper element
            var initialX = 0;
            var currentTranslateX = 0;
            var isSwiping = false;
            var currentParticipantBeingPickedUp = null; // Stores the participant object for the pickup modal
            var currentLoggedInUsername = ''; // Global variable for logged-in user's name
            var currentLoggedInUserStatus = ''; // Global variable for logged-in user's status (admin/Betreuer)
            var controlModeActive = false; // Initial state for control mode
            var currentParticipantInDetailsModal = null; // Stores the participant object currently displayed in the details modal
            var fullInstructionsVisible = false; // NEW: State for instruction visibility
            
            // NEW: Filter variables
            var currentFirstNameFilter = 'ALLE';
            var currentLastNameFilter = 'ALLE';

            // Globale Funktion zum Anzeigen von Nachrichten (Fehler oder Erfolg)
            window.showMessage = function(message, isError = true) {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden');
                if (isError) {
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    messageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    messageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            };

            // Funktion zum Anzeigen der Aktions-Feedback-Nachricht (von oben)
            function showActionFeedback(message, isSuccess = true) {
                actionFeedbackMessage.textContent = message;
                actionFeedbackMessage.classList.remove('bg-green-500', 'bg-red-500');
                actionFeedbackMessage.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
                actionFeedbackMessage.classList.add('show');
                setTimeout(() => {
                    actionFeedbackMessage.classList.remove('show');
                }, 2000);
            }

            function showPickupMessageBox(message, isError = true) {
                pickupMessageBox.textContent = message;
                pickupMessageBox.classList.remove('hidden');
                if (isError) {
                    pickupMessageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    pickupMessageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    pickupMessageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    pickupMessageBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                }
                setTimeout(() => {
                    pickupMessageBox.classList.add('hidden');
                }, 3000);
            }
            
            function showAdminMessage(messageElement, message, isError = true) {
                messageElement.textContent = message;
                messageElement.classList.remove('hidden', 'text-red-700', 'text-green-700');
                if (isError) {
                    messageElement.classList.add('text-red-700');
                } else {
                    messageElement.classList.add('text-green-700');
                }
                setTimeout(() => messageElement.classList.add('hidden'), 3000);
            }

            // --- Local Storage Management für Benutzer ---
            const LOCAL_STORAGE_USERS_KEY = 'ferienprogramm_users';
            let users = [];

            function loadUsers() {
                try {
                    const storedUsers = localStorage.getItem(LOCAL_STORAGE_USERS_KEY);
                    if (storedUsers) {
                        users = JSON.parse(storedUsers);
                    } else {
                        users = [
                            { id: Date.now().toString() + '0', username: 'Betreuer', code: '1111', status: 'Betreuer' },
                            { id: Date.now().toString() + '1', username: 'Admin', code: '240309', status: 'admin' }
                        ];
                        saveUsers();
                    }
                } catch (e) {
                    console.error("Fehler beim Laden der Benutzer aus Local Storage:", e);
                    window.showMessage("Fehler beim Laden der Benutzerdaten.", true);
                    users = [];
                }
            }

            function saveUsers() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_USERS_KEY, JSON.stringify(users));
                    renderUserList();
                } catch (e) {
                    console.error("Fehler beim Speichern der Benutzer in Local Storage:", e);
                    window.showMessage("Fehler beim Speichern der Benutzerdaten.", true);
                }
            }

            // --- Local Storage Management für Teilnehmer ---
            const LOCAL_STORAGE_PARTICIPANTS_KEY = 'ferienprogramm_participants';
            const LOCAL_STORAGE_CONTROL_MODE_KEY = 'ferienprogramm_control_mode'; // New key for control mode
            let participants = [];

            function loadParticipants() {
                try {
                    const storedParticipants = localStorage.getItem(LOCAL_STORAGE_PARTICIPANTS_KEY);
                    if (storedParticipants) {
                        participants = JSON.parse(storedParticipants).map(p => ({
                            ...p,
                            savedStatus: p.status, // Ensure savedStatus is always present for internal state management
                            registrationType: p.registrationType || 'Tagesanmeldung',
                            street: p.street || '',
                            city: p.city || '',
                            phone: p.phone || '', // Initialize new phone field
                            paid: p.paid !== undefined ? p.paid : false,
                            canGoHomeAlone: p.canGoHomeAlone !== undefined ? p.canGoHomeAlone : false,
                            pickedUpBy: '',
                            activityHistory: p.activityHistory || [], // Ensure history is an array
                            comments: p.comments || [], // Ensure comments is an array
                        }));
                    } else {
                        // Beispiel-Teilnehmer (initial)
                        participants = [
                            { id: 'p1', firstName: 'Lena', lastName: 'Muster', status: 'initial', savedStatus: 'initial', registrationType: 'Tagesanmeldung', street: 'Musterweg 1', city: 'Musterstadt', phone: '0171234567', paid: true, canGoHomeAlone: false, pickedUpBy: '', activityHistory: [], comments: [] },
                            { id: 'p2', firstName: 'Max', lastName: 'Mustermann', status: 'anwesend', savedStatus: 'anwesend', registrationType: 'Wochenanmeldung', street: 'Beispielallee 5', city: 'Beispielburg', phone: '0151987654', paid: false, canGoHomeAlone: true, pickedUpBy: '', activityHistory: [{ type: 'anmeldung', time: new Date().toISOString(), user: 'Admin' }], comments: [] },
                            { id: 'p3', firstName: 'Emil', lastName: 'Schmidt', status: 'abwesend', savedStatus: 'abwesend', registrationType: 'Tagesanmeldung', street: 'Hauptstraße 10', city: 'Hauptstadt', phone: '01701122334', paid: true, canGoHomeAlone: true, pickedUpBy: '', activityHistory: [], comments: [{ text: 'Benötigt spezielle Betreuung.', time: new Date().toISOString(), user: 'Admin' }] },
                        ];
                        saveParticipants();
                    }
                    // Initial rendering after loading
                    renderUnifiedParticipantList();
                } catch (e) {
                    console.error("Fehler beim Laden der Teilnehmer aus Local Storage:", e);
                    window.showMessage("Fehler beim Laden der Teilnehmerdaten.", true);
                    participants = [];
                }
            }
            
            function loadControlMode() {
                try {
                    const storedMode = localStorage.getItem(LOCAL_STORAGE_CONTROL_MODE_KEY);
                    controlModeActive = storedMode === 'true';
                    controlModeToggle.checked = controlModeActive;
                } catch (e) {
                    console.error("Fehler beim Laden des Kontrollmodus:", e);
                }
            }

            function saveParticipants() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_PARTICIPANTS_KEY, JSON.stringify(participants));
                    renderUnifiedParticipantList();
                } catch (e) {
                    console.error("Fehler beim Speichern der Teilnehmer in Local Storage:", e);
                    window.showMessage("Fehler beim Speichern der Teilnehmerdaten.", true);
                }
            }

            // Function to find a participant by ID
            function findParticipantById(id) {
                return participants.find(p => p.id === id);
            }
            
            function updatePresentParticipantsCount() {
                const presentCount = participants.filter(p => p.status === 'anwesend').length;
                presentParticipantsCount.textContent = `Aktuell ${presentCount} Teilnehmer angemeldet.`;
            }

            // --- Participant List Rendering & Management ---

            function renderUnifiedParticipantList() {
                unifiedParticipantList.innerHTML = '';
                let noParticipantsFound = true;
                
                const searchQuery = participantSearchInput.value.toLowerCase();
                
                const filteredParticipants = participants.filter(p => {
                    const fullName = `${p.firstName.toLowerCase()} ${p.lastName.toLowerCase()}`;
                    const matchesSearch = fullName.includes(searchQuery);
                    
                    const matchesFirstNameFilter = currentFirstNameFilter === 'ALLE' || p.firstName.toUpperCase().startsWith(currentFirstNameFilter);
                    const matchesLastNameFilter = currentLastNameFilter === 'ALLE' || p.lastName.toUpperCase().startsWith(currentLastNameFilter);

                    return matchesSearch && matchesFirstNameFilter && matchesLastNameFilter;
                }).sort((a, b) => a.lastName.localeCompare(b.lastName) || a.firstName.localeCompare(b.firstName)); // Sort by last name, then first name

                if (filteredParticipants.length > 0) {
                    noParticipantsFound = false;
                    filteredParticipants.forEach(p => {
                        const listItem = document.createElement('li');
                        // Applying original simpler styles for list items
                        listItem.classList.add('participant-item-container', 'relative', 'select-none', 'transition-shadow', 'duration-200');
                        listItem.dataset.participantId = p.id;
                        
                        // No red border on container, only name text color
                        
                        const contentWrapper = document.createElement('div');
                        contentWrapper.classList.add('participant-content-wrapper', 'flex', 'items-center', 'justify-between', 'space-x-4', 'relative', 'z-10', 'bg-white');
                        
                        let dotColorClass = '';
                        if (p.status === 'anwesend') {
                            dotColorClass = 'bg-green-500';
                        } else if (p.status === 'abwesend') {
                            dotColorClass = 'bg-red-500';
                        } else {
                            dotColorClass = 'bg-gray-400'; // Initial state
                        }

                        let nameColorClass = 'text-gray-800';
                        if (controlModeActive && !p.paid) {
                            nameColorClass = 'text-red-500'; // Name red if unpaid in control mode
                        }
                        
                        const regInfo = `${p.registrationType} | Alleine: ${p.canGoHomeAlone ? 'Ja' : 'Nein'}`;

                        contentWrapper.innerHTML = `
                            <div class="flex-grow flex items-center">
                                <span class="status-dot ${dotColorClass}"></span>
                                <p class="text-lg font-semibold ${nameColorClass}">${p.firstName} ${p.lastName}</p>
                            </div>
                            <div class="flex items-center space-x-2 flex-shrink-0 text-gray-500 text-sm">
                                ${regInfo}
                                ${p.comments && p.comments.length > 0 ? `<span class="comment-icon">C</span>` : ''}
                                <span class="info-icon" data-participant-id="${p.id}" title="Details ansehen">ⓘ</span>
                            </div>
                        `;
                        
                        const actionButtonContainer = document.createElement('div');
                        actionButtonContainer.classList.add('participant-action-button-container');

                        const actionButton = document.createElement('button');
                        actionButton.classList.add('participant-action-button', 'font-semibold', 'text-white', 'py-2', 'px-4');
                        actionButton.dataset.actionType = p.status === 'abwesend' || p.status === 'initial' ? 'anmelden' : 'abmelden';
                        actionButton.classList.add(p.status === 'abwesend' || p.status === 'initial' ? 'anmelden-button' : 'abmelden-button');
                        actionButton.textContent = p.status === 'abwesend' || p.status === 'initial' ? 'Anmelden' : 'Abmelden';
                        
                        actionButtonContainer.appendChild(actionButton);
                        
                        listItem.appendChild(actionButtonContainer);
                        listItem.appendChild(contentWrapper);
                        
                        unifiedParticipantList.appendChild(listItem);
                    });
                }
                
                noParticipantsMessageUnified.classList.toggle('hidden', !noParticipantsFound);
                updatePresentParticipantsCount(); // Update the count after rendering
            }

            function handleParticipantStatusChange(participant, newStatus) {
                const oldStatus = participant.status;
                if (oldStatus === newStatus) {
                    showActionFeedback(`Teilnehmer ist bereits ${newStatus === 'anwesend' ? 'angemeldet' : 'abgemeldet'}.`, false);
                    return;
                }
                
                participant.status = newStatus;
                participant.savedStatus = newStatus; // Also update the savedStatus
                
                // Add to activity history
                participant.activityHistory.push({
                    type: newStatus === 'anwesend' ? 'anmeldung' : 'abmeldung', // FIX: Added the 'else' part of the ternary operator
                    time: new Date().toISOString(),
                    user: currentLoggedInUsername
                });
                
                // If checking in, reset pickup information
                if (newStatus === 'anwesend') {
                    participant.pickedUpBy = '';
                }
                
                saveParticipants();
                showActionFeedback(`Teilnehmer ${participant.firstName} ${participant.lastName} wurde erfolgreich ${newStatus === 'anwesend' ? 'angemeldet' : 'abgemeldet'}.`, true);
            }

            // --- Event Listeners ---

            keypadButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value;
                    const action = button.dataset.action;

                    if (action === 'clear') {
                        enteredCode = enteredCode.slice(0, -1);
                    } else if (action === 'enter') {
                        const user = users.find(u => u.code === enteredCode);
                        if (user) {
                            currentLoggedInUsername = user.username;
                            currentLoggedInUserStatus = user.status;
                            if (user.status === 'admin') {
                                loginScreen.classList.add('hidden');
                                adminContentScreen.classList.remove('hidden');
                                unifiedParticipantContainer.classList.add('hidden');
                            } else {
                                loginScreen.classList.add('hidden');
                                mainContentScreen.classList.remove('hidden');
                                unifiedParticipantContainer.classList.remove('hidden');
                                betreuerNameDisplay.textContent = user.username;
                                // In Betreuer-Modus, immer die Teilnehmerliste anzeigen
                                renderUnifiedParticipantList();
                                generateAlphabetFilters();
                            }
                            window.showMessage('Erfolgreich angemeldet!', false);
                        } else {
                            window.showMessage('Falscher Code.', true);
                            enteredCode = '';
                        }
                        enteredCode = '';
                    } else if (value) {
                        if (enteredCode.length < 6) {
                            enteredCode += value;
                        }
                    }
                    // Display asterisks for the code
                    codeDisplay.textContent = '*'.repeat(enteredCode.length);
                });
            });

            logoutButtonMain.addEventListener('click', () => {
                currentLoggedInUsername = '';
                currentLoggedInUserStatus = '';
                mainContentScreen.classList.add('hidden');
                unifiedParticipantContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                enteredCode = '';
                codeDisplay.textContent = '';
                // reset filters
                currentFirstNameFilter = 'ALLE';
                currentLastNameFilter = 'ALLE';
                // Reset dropdowns on logout
                if (filterFirstNameSelect) filterFirstNameSelect.value = 'ALLE';
                if (filterLastNameSelect) filterLastNameSelect.value = 'ALLE';
                // Hide full instructions on logout
                fullInstructionsVisible = false;
                fullInstructions.classList.add('hidden');
                instructionToggleText.textContent = 'für weitere Instruktionen hier klicken';
            });
            
            logoutButtonAdmin.addEventListener('click', () => {
                currentLoggedInUsername = '';
                currentLoggedInUserStatus = '';
                adminContentScreen.classList.add('hidden');
                unifiedParticipantContainer.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                enteredCode = '';
                codeDisplay.textContent = '';
            });

            // Universal Swipe Logic
            unifiedParticipantList.addEventListener('pointerdown', (e) => {
                // Ignore if not a participant item
                const itemContainer = e.target.closest('.participant-item-container');
                if (!itemContainer) return;

                // Close any currently open item first
                if (activeSwipeItem && activeSwipeItem !== itemContainer) {
                    activeSwipeItem.classList.remove('swiped');
                    activeSwipeItem.querySelector('.participant-content-wrapper').style.transform = 'translateX(0)';
                    activeSwipeItem = null;
                    return; // Prevent immediate swipe on a new item
                }
                
                const contentWrapper = itemContainer.querySelector('.participant-content-wrapper');

                isSwiping = true;
                initialX = e.clientX;
                currentTranslateX = parseFloat(getComputedStyle(contentWrapper).transform.split(',')[4] || 0);

                const onPointerMove = (moveEvent) => {
                    if (!isSwiping) return;
                    
                    const dx = moveEvent.clientX - initialX;
                    const newTranslateX = Math.min(0, Math.max(-120, dx + currentTranslateX));
                    
                    contentWrapper.style.transform = `translateX(${newTranslateX}px)`;

                    // Determine if the item should be marked as swiped
                    if (newTranslateX < -60) {
                        itemContainer.classList.add('swiped');
                        activeSwipeItem = itemContainer;
                    } else {
                        itemContainer.classList.remove('swiped');
                    }
                };

                const onPointerUp = () => {
                    isSwiping = false;
                    document.removeEventListener('pointermove', onPointerMove);
                    document.removeEventListener('pointerup', onPointerUp);

                    // Snap to final position
                    if (itemContainer.classList.contains('swiped')) {
                        contentWrapper.style.transform = 'translateX(-120px)';
                    } else {
                        contentWrapper.style.transform = 'translateX(0px)';
                        activeSwipeItem = null;
                    }
                };
                
                document.addEventListener('pointermove', onPointerMove);
                document.addEventListener('pointerup', onPointerUp);
            });

            // Click listener for action buttons
            unifiedParticipantList.addEventListener('click', (e) => {
                const actionButton = e.target.closest('.participant-action-button');
                const infoIcon = e.target.closest('.info-icon');
                const commentIcon = e.target.closest('.comment-icon');

                if (actionButton) {
                    e.stopPropagation(); // Prevent swipe-to-close on button click
                    const itemContainer = actionButton.closest('.participant-item-container');
                    const participantId = itemContainer.dataset.participantId;
                    const participant = findParticipantById(participantId);
                    const actionType = actionButton.dataset.actionType;

                    if (participant) {
                        if (actionType === 'abmelden' && !participant.canGoHomeAlone) {
                            // Show pickup modal
                            currentParticipantBeingPickedUp = participant;
                            pickupParticipantName.textContent = `${participant.firstName} ${participant.lastName}`;
                            pickupModal.classList.remove('hidden');
                        } else {
                            // Handle change directly
                            const newStatus = actionType === 'anmelden' ? 'anwesend' : 'abwesend';
                            handleParticipantStatusChange(participant, newStatus);
                            if (activeSwipeItem) {
                                activeSwipeItem.classList.remove('swiped');
                                activeSwipeItem.querySelector('.participant-content-wrapper').style.transform = 'translateX(0)';
                                activeSwipeItem = null;
                            }
                        }
                    }
                } else if (infoIcon) {
                    e.stopPropagation();
                    const participantId = infoIcon.dataset.participantId;
                    const participant = findParticipantById(participantId);
                    if (participant) {
                        currentParticipantInDetailsModal = participant;
                        populateDetailsModal(participant);
                        participantDetailsModal.classList.remove('hidden');
                    }
                } else if (commentIcon) {
                    e.stopPropagation();
                    const itemContainer = commentIcon.closest('.participant-item-container');
                    const participantId = itemContainer.dataset.participantId;
                    const participant = findParticipantById(participantId);
                    if (participant) {
                        currentParticipantInDetailsModal = participant;
                        populateDetailsModal(participant);
                        participantDetailsModal.classList.remove('hidden');
                        // Scroll to comments section
                        const commentsSection = document.getElementById('details-comment-section');
                        if (commentsSection) {
                             commentsSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }
                } else {
                    // Clicks outside a button will close a swiped item
                    const swipedItem = document.querySelector('.participant-item-container.swiped');
                    if (swipedItem) {
                        swipedItem.classList.remove('swiped');
                        swipedItem.querySelector('.participant-content-wrapper').style.transform = 'translateX(0)';
                        activeSwipeItem = null;
                    }
                }
            });


            // --- Pickup Modal Logic ---
            pickupPersonSelect.addEventListener('change', () => {
                if (pickupPersonSelect.value === 'Sonstige') {
                    customPickupPersonContainer.classList.remove('hidden');
                    customPickupPersonInput.required = true;
                } else {
                    customPickupPersonContainer.classList.add('hidden');
                    customPickupPersonInput.required = false;
                }
            });

            cancelPickupButton.addEventListener('click', () => {
                pickupModal.classList.add('hidden');
                pickupPersonSelect.value = '';
                customPickupPersonInput.value = '';
                customPickupPersonContainer.classList.add('hidden');
                currentParticipantBeingPickedUp = null;
            });

            confirmPickupButton.addEventListener('click', () => {
                const pickupPerson = pickupPersonSelect.value;
                const customPerson = customPickupPersonInput.value.trim();
                
                if (!pickupPerson) {
                    showPickupMessageBox('Bitte wählen Sie eine Abholperson aus.', true);
                    return;
                }

                if (pickupPerson === 'Sonstige' && !customPerson) {
                    showPickupMessageBox('Bitte geben Sie den Namen der abholenden Person ein.', true);
                    return;
                }
                
                const finalPickupPerson = pickupPerson === 'Sonstige' ? customPerson : pickupPerson;
                
                // Update participant
                const participant = currentParticipantBeingPickedUp;
                if (participant) {
                    participant.status = 'abgemeldet';
                    participant.savedStatus = 'abgemeldet';
                    participant.pickedUpBy = finalPickupPerson;

                    // Add to activity history
                    participant.activityHistory.push({
                        type: 'abmeldung',
                        time: new Date().toISOString(),
                        user: currentLoggedInUsername,
                        pickupPerson: finalPickupPerson
                    });

                    saveParticipants();
                    showActionFeedback(`Teilnehmer ${participant.firstName} ${participant.lastName} wurde erfolgreich an ${finalPickupPerson} übergeben.`, true);
                    pickupModal.classList.add('hidden');
                    pickupPersonSelect.value = '';
                    customPickupPersonInput.value = '';
                    customPickupPersonContainer.classList.add('hidden');
                    currentParticipantBeingPickedUp = null;

                    // Close any swiped item
                    if (activeSwipeItem) {
                        activeSwipeItem.classList.remove('swiped');
                        activeSwipeItem.querySelector('.participant-content-wrapper').style.transform = 'translateX(0)';
                        activeSwipeItem = null;
                    }
                }
            });

            // --- Details Modal Logic ---
            closeDetailsModalButton.addEventListener('click', () => {
                participantDetailsModal.classList.add('hidden');
                // Reset to display mode
                toggleDetailsEditMode(false);
            });
            
            function populateDetailsModal(participant) {
                // Set the title
                detailsModalTitle.textContent = `Details: ${participant.firstName} ${participant.lastName}`;

                // Set display values
                detailsFirstNameDisplay.textContent = participant.firstName;
                detailsLastNameDisplay.textContent = participant.lastName;
                detailsStreetDisplay.textContent = participant.street;
                detailsCityDisplay.textContent = participant.city;
                detailsPhoneDisplay.textContent = participant.phone;
                detailsRegtypeDisplay.textContent = participant.registrationType;
                detailsPaidDisplay.textContent = participant.paid ? 'Ja' : 'Nein';
                detailsCanGoHomeAloneDisplay.textContent = participant.canGoHomeAlone ? 'Ja' : 'Nein';

                // Show/hide picked-up-by row
                if (participant.pickedUpBy) {
                    detailsPickedUpByRow.classList.remove('hidden');
                    detailsPickedUpBy.textContent = participant.pickedUpBy;
                } else {
                    detailsPickedUpByRow.classList.add('hidden');
                }
                
                // Populate comments
                renderComments(participant);

                // Populate activity history
                renderActivityHistory(participant);

                // Admin-specific edit mode setup
                if (currentLoggedInUserStatus === 'admin') {
                    saveDetailsButton.classList.remove('hidden');
                    toggleDetailsEditMode(true);
                } else {
                    saveDetailsButton.classList.add('hidden');
                    toggleDetailsEditMode(false);
                }
            }

            function toggleDetailsEditMode(isEditMode) {
                const elementsToToggle = [
                    detailsFirstNameDisplay, detailsLastNameDisplay, detailsStreetDisplay, detailsCityDisplay, detailsPhoneDisplay, detailsRegtypeDisplay, detailsPaidDisplay, detailsCanGoHomeAloneDisplay,
                    detailsFirstNameInput, detailsLastNameInput, detailsStreetInput, detailsCityInput, detailsPhoneInput, detailsRegtypeSelect, detailsPaidInput, detailsCanGoHomeAloneInput
                ];
                
                elementsToToggle.forEach(el => {
                    const isInput = el.tagName === 'INPUT' || el.tagName === 'SELECT';
                    el.classList.toggle('hidden', isEditMode !== isInput);
                });

                // Update input values from display values if entering edit mode
                if (isEditMode) {
                    detailsFirstNameInput.value = detailsFirstNameDisplay.textContent;
                    detailsLastNameInput.value = detailsLastNameDisplay.textContent;
                    detailsStreetInput.value = detailsStreetDisplay.textContent;
                    detailsCityInput.value = detailsCityDisplay.textContent;
                    detailsPhoneInput.value = detailsPhoneDisplay.textContent;
                    detailsRegtypeSelect.value = detailsRegtypeDisplay.textContent;
                    detailsPaidInput.checked = detailsPaidDisplay.textContent === 'Ja';
                    detailsCanGoHomeAloneInput.checked = detailsCanGoHomeAloneDisplay.textContent === 'Ja';
                }
            }
            
            saveDetailsButton.addEventListener('click', () => {
                if (!currentParticipantInDetailsModal) return;
                
                const p = currentParticipantInDetailsModal;

                // Update participant object
                p.firstName = detailsFirstNameInput.value;
                p.lastName = detailsLastNameInput.value;
                p.street = detailsStreetInput.value;
                p.city = detailsCityInput.value;
                p.phone = detailsPhoneInput.value;
                p.registrationType = detailsRegtypeSelect.value;
                p.paid = detailsPaidInput.checked;
                p.canGoHomeAlone = detailsCanGoHomeAloneInput.checked;
                
                saveParticipants();
                
                // Re-populate and switch back to display mode
                populateDetailsModal(p);
                participantDetailsModal.classList.add('hidden');
                showActionFeedback(`Teilnehmerdaten für ${p.firstName} ${p.lastName} gespeichert.`, true);
            });

            addCommentButton.addEventListener('click', () => {
                if (!currentParticipantInDetailsModal) return;
                const commentText = newCommentText.value.trim();
                if (commentText) {
                    const newComment = {
                        text: commentText,
                        time: new Date().toISOString(),
                        user: currentLoggedInUsername
                    };
                    currentParticipantInDetailsModal.comments.push(newComment);
                    saveParticipants();
                    newCommentText.value = '';
                    renderComments(currentParticipantInDetailsModal);
                    showActionFeedback('Kommentar hinzugefügt.', true);
                }
            });

            function renderComments(participant) {
                detailsCommentsList.innerHTML = '';
                if (participant.comments && participant.comments.length > 0) {
                    noCommentsMessage.classList.add('hidden');
                    participant.comments.forEach(c => {
                        const commentEl = document.createElement('div');
                        commentEl.classList.add('p-2', 'bg-white', 'rounded-md', 'shadow-sm', 'border', 'border-gray-200');
                        commentEl.innerHTML = `
                            <p class="text-sm text-gray-800">${c.text}</p>
                            <p class="text-xs text-gray-500 mt-1">Hinzugefügt von ${c.user} am ${new Date(c.time).toLocaleString('de-DE')}</p>
                        `;
                        detailsCommentsList.appendChild(commentEl);
                    });
                } else {
                    noCommentsMessage.classList.remove('hidden');
                }
            }

            function renderActivityHistory(participant) {
                detailsActivityHistory.innerHTML = '';
                if (participant.activityHistory && participant.activityHistory.length > 0) {
                    noHistoryMessage.classList.add('hidden');
                    participant.activityHistory.sort((a, b) => new Date(b.time) - new Date(a.time)).forEach(a => {
                        const historyEl = document.createElement('li');
                        let text = '';
                        const time = new Date(a.time).toLocaleString('de-DE');
                        if (a.type === 'anmeldung') {
                            text = `Angemeldet von ${a.user} am ${time}`;
                        } else if (a.type === 'abmeldung') {
                            text = `Abgemeldet von ${a.user} am ${time}`;
                            if (a.pickupPerson) {
                                text += ` (abgeholt von: ${a.pickupPerson})`;
                            }
                        }
                        historyEl.textContent = text;
                        historyEl.classList.add('border-b', 'border-gray-200', 'py-1');
                        detailsActivityHistory.appendChild(historyEl);
                    });
                } else {
                    noHistoryMessage.classList.remove('hidden');
                }
            }


            // --- Admin Tab Navigation ---
            navUserManagementButton.addEventListener('click', () => {
                setActiveAdminSection(navUserManagementButton, userManagementSection);
                loadUsers(); // Load users when switching to this tab
            });

            navParticipantManagementButton.addEventListener('click', () => {
                 setActiveAdminSection(navParticipantManagementButton, participantManagementSection);
            });
            
            navParticipantOverviewButton.addEventListener('click', () => {
                 setActiveAdminSection(navParticipantOverviewButton, adminParticipantOverviewSection);
                 unifiedParticipantContainer.classList.remove('hidden');
                 renderUnifiedParticipantList();
                 generateAlphabetFilters();
            });

            navProgramSettingsButton.addEventListener('click', () => {
                 setActiveAdminSection(navProgramSettingsButton, programSettingsSection);
            });

            function setActiveAdminSection(activeButton, activeSection) {
                adminNavButtons.forEach(btn => btn.classList.remove('active'));
                activeButton.classList.add('active');

                const allAdminSections = document.querySelectorAll('#admin-section-wrapper > div');
                allAdminSections.forEach(section => section.classList.add('hidden'));

                adminSectionWrapper.classList.remove('hidden');
                adminWelcomeMessage.classList.add('hidden');
                activeSection.classList.remove('hidden');
                
                // Hide participant container if we're not on the overview tab
                if (activeButton.id !== 'nav-participant-overview') {
                    unifiedParticipantContainer.classList.add('hidden');
                }
            }

            // --- Admin User Management Logic ---
            addUserButton.addEventListener('click', () => {
                const username = newUsernameInput.value.trim();
                const code = newUserCodeInput.value.trim();
                const status = newUserStatusSelect.value;
                if (username && code && status) {
                    if (users.some(u => u.code === code)) {
                        showAdminMessage(addUserMessage, 'Fehler: Zugangscode existiert bereits.', true);
                        return;
                    }
                    const newUser = {
                        id: Date.now().toString(),
                        username: username,
                        code: code,
                        status: status
                    };
                    users.push(newUser);
                    saveUsers();
                    newUsernameInput.value = '';
                    newUserCodeInput.value = '';
                    showAdminMessage(addUserMessage, 'Benutzer erfolgreich hinzugefügt.', false);
                } else {
                    showAdminMessage(addUserMessage, 'Bitte alle Felder ausfüllen.', true);
                }
            });

            function renderUserList() {
                userListElement.innerHTML = '';
                if (users.length === 0) {
                    noUsersMessage.classList.remove('hidden');
                    return;
                }
                noUsersMessage.classList.add('hidden');
                users.forEach(user => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'items-center', 'justify-between', 'bg-white', 'p-3', 'rounded-lg', 'shadow-sm');
                    listItem.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${user.username} (${user.status})</p>
                            <p class="text-sm text-gray-500">Code: ${user.code}</p>
                        </div>
                        <button class="delete-user-button bg-red-500 hover:bg-red-600 text-white text-sm font-semibold py-1 px-3 rounded-lg transition-all duration-200" data-user-id="${user.id}">Löschen</button>
                    `;
                    userListElement.appendChild(listItem);
                });
            }

            userListElement.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-user-button');
                if (deleteButton) {
                    const userId = deleteButton.dataset.userId;
                    const user = users.find(u => u.id === userId);
                    if (user && users.length > 1) { // Prevent deleting the last user
                        itemToDelete = { id: userId, type: 'user', name: user.username };
                        deleteModalTitle.textContent = 'Benutzer löschen';
                        deleteModalMessage.textContent = `Bist du sicher, dass du den Benutzer "${user.username}" löschen möchtest?`;
                        deleteModal.classList.remove('hidden');
                    } else {
                        showAdminMessage(document.getElementById('add-user-message'), 'Kann den letzten Benutzer nicht löschen.', true);
                    }
                }
            });


            // --- Admin Participant Management Logic ---
            function addNewParticipant(status) {
                const firstName = newParticipantFirstNameInput.value.trim();
                const lastName = newParticipantLastNameInput.value.trim(); // Corrected to use lastNameInput
                if (!firstName || !lastName) {
                    showAdminMessage(addParticipantManualMessage, 'Vor- und Nachname sind erforderlich.', true);
                    return;
                }
                
                const newParticipant = {
                    id: 'p' + Date.now().toString(),
                    firstName: firstName,
                    lastName: lastName,
                    status: status, // Use the provided status
                    savedStatus: status, // Set savedStatus to the same
                    registrationType: newParticipantRegtypeSelect.value,
                    street: newParticipantStreetInput.value.trim(),
                    city: newParticipantCityInput.value.trim(),
                    phone: newParticipantPhoneInput.value.trim(),
                    paid: newParticipantPaidCheckbox.checked,
                    canGoHomeAlone: newParticipantCanGoHomeAloneCheckbox.checked,
                    pickedUpBy: '',
                    activityHistory: status === 'anwesend' ? [{ type: 'anmeldung', time: new Date().toISOString(), user: currentLoggedInUsername }] : [],
                    comments: []
                };

                participants.push(newParticipant);
                saveParticipants();
                
                // Clear form
                newParticipantFirstNameInput.value = '';
                newParticipantLastNameInput.value = '';
                newParticipantRegtypeSelect.value = 'Tagesanmeldung';
                newParticipantStreetInput.value = '';
                newParticipantCityInput.value = '';
                newParticipantPhoneInput.value = '';
                newParticipantPaidCheckbox.checked = false;
                newParticipantCanGoHomeAloneCheckbox.checked = false;
                
                showAdminMessage(addParticipantManualMessage, `Teilnehmer erfolgreich hinzugefügt ${status === 'anwesend' ? 'und angemeldet' : ''}.`, false);
            }

            addParticipantManualButton.addEventListener('click', () => {
                addNewParticipant('initial'); // Default to 'initial'
            });

            addAndRegisterParticipantButton.addEventListener('click', () => {
                addNewParticipant('anwesend'); // Set status to 'anwesend'
            });


            importParticipantsButton.addEventListener('click', () => {
                const file = importParticipantsFileInput.files[0];
                if (!file) {
                    showAdminMessage(importParticipantsMessage, 'Bitte wählen Sie eine Excel-Datei aus.', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        if (json.length > 1) {
                            const header = json[0].map(h => h.trim());
                            const rows = json.slice(1);
                            
                            const newParticipants = rows.map(row => {
                                const newP = {
                                    id: 'p' + Date.now().toString() + Math.random().toString().substring(2, 8),
                                    firstName: '',
                                    lastName: '',
                                    status: 'initial', // Default to 'initial'
                                    savedStatus: 'initial', // Default to 'initial'
                                    registrationType: 'Tagesanmeldung', // Default
                                    street: '',
                                    city: '',
                                    phone: '',
                                    paid: false,
                                    canGoHomeAlone: false,
                                    pickedUpBy: '',
                                    activityHistory: [],
                                    comments: []
                                };
                                
                                const nameIndex = header.indexOf('Name');
                                const vornameIndex = header.indexOf('Vorname');
                                const streetIndex = header.indexOf('Straße');
                                const cityIndex = header.indexOf('Ort');
                                const phoneIndex = header.indexOf('Tel.');
                                const goHomeIndex = header.indexOf('Darf alleine nach Hause?');
                                const paidIndex = header.indexOf('Bezahlt?');
                                const regtypeIndex = header.indexOf('Anmeldeart');
                                
                                if (vornameIndex !== -1) newP.firstName = row[vornameIndex] || '';
                                if (nameIndex !== -1) newP.lastName = row[nameIndex] || '';
                                if (streetIndex !== -1) newP.street = row[streetIndex] || '';
                                if (cityIndex !== -1) newP.city = row[cityIndex] || '';
                                if (phoneIndex !== -1) newP.phone = row[phoneIndex] || '';
                                if (regtypeIndex !== -1) newP.registrationType = row[regtypeIndex] || 'Tagesanmeldung';
                                if (goHomeIndex !== -1) newP.canGoHomeAlone = row[goHomeIndex] === 'Ja';
                                if (paidIndex !== -1) newP.paid = row[paidIndex] === 'Ja';
                                
                                return newP;
                            });

                            // Filter out participants with no name
                            const validParticipants = newParticipants.filter(p => p.firstName || p.lastName);
                            
                            if (validParticipants.length > 0) {
                                participants.push(...validParticipants);
                                saveParticipants();
                                showAdminMessage(importParticipantsMessage, `${validParticipants.length} Teilnehmer erfolgreich importiert.`, false);
                            } else {
                                showAdminMessage(importParticipantsMessage, 'Keine gültigen Teilnehmer in der Datei gefunden.', true);
                            }
                            
                        } else {
                            showAdminMessage(importParticipantsMessage, 'Die Excel-Datei ist leer oder hat keine Datenzeilen.', true);
                        }

                    } catch (error) {
                        console.error('Fehler beim Parsen der Excel-Datei:', error);
                        showAdminMessage(importParticipantsMessage, 'Fehler beim Lesen der Datei. Stellen Sie sicher, dass das Format korrekt ist.', true);
                    }
                };
                reader.readAsArrayBuffer(file);
            });

            // --- Admin Program Settings Logic ---
            controlModeToggle.addEventListener('change', () => {
                controlModeActive = controlModeToggle.checked;
                localStorage.setItem(LOCAL_STORAGE_CONTROL_MODE_KEY, controlModeActive);
                renderUnifiedParticipantList(); // Re-render to apply/remove classes
            });
            
            // Re-render to ensure red borders are applied on load if controlMode is active
            window.addEventListener('DOMContentLoaded', loadControlMode);


            removeAllParticipantsButton.addEventListener('click', () => {
                itemToDelete = { type: 'all-participants', name: 'Alle Teilnehmer' };
                deleteModalTitle.textContent = 'Alle Teilnehmer löschen';
                deleteModalMessage.textContent = 'WARNUNG: Bist du sicher, dass du ALLE Teilnehmer unwiderruflich löschen möchtest?';
                deleteModal.classList.remove('hidden');
            });

            removeDailyParticipantsButton.addEventListener('click', () => {
                itemToDelete = { type: 'daily-participants', name: 'Alle Tagesanmeldungen' };
                deleteModalTitle.textContent = 'Tagesanmeldungen löschen';
                deleteModalMessage.textContent = 'Bist du sicher, dass du ALLE Teilnehmer mit dem Typ "Tagesanmeldung" löschen möchtest?';
                deleteModal.classList.remove('hidden');
            });

            resetAllParticipantsButton.addEventListener('click', () => {
                itemToDelete = { type: 'reset-all', name: 'Status aller Teilnehmer zurücksetzen' };
                deleteModalTitle.textContent = 'Status zurücksetzen';
                deleteModalMessage.textContent = 'Bist du sicher, dass du den Status (Anwesend/Abwesend) aller Teilnehmer und die Abholinformationen zurücksetzen möchtest?';
                deleteModal.classList.remove('hidden');
            });


            // --- General Confirmation Modal Logic ---
            cancelDeleteButton.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
                itemToDelete = null;
            });
            
            confirmDeleteButton.addEventListener('click', () => {
                if (!itemToDelete) {
                    deleteModal.classList.add('hidden');
                    return;
                }
                
                if (itemToDelete.type === 'user') {
                    users = users.filter(u => u.id !== itemToDelete.id);
                    saveUsers();
                    showAdminMessage(document.getElementById('add-user-message'), `Benutzer "${itemToDelete.name}" gelöscht.`, false);
                } else if (itemToDelete.type === 'all-participants') {
                    participants = [];
                    saveParticipants();
                    showAdminMessage(document.getElementById('add-participant-manual-message'), `Alle Teilnehmer gelöscht.`, false);
                } else if (itemToDelete.type === 'daily-participants') {
                    participants = participants.filter(p => p.registrationType !== 'Tagesanmeldung');
                    saveParticipants();
                    showAdminMessage(document.getElementById('add-participant-manual-message'), `Alle Tagesanmeldungen gelöscht.`, false);
                } else if (itemToDelete.type === 'reset-all') {
                    participants.forEach(p => {
                        p.status = 'initial'; // Reset to initial
                        p.savedStatus = 'initial'; // Reset to initial
                        p.pickedUpBy = '';
                        p.activityHistory = []; // Clear history
                        p.comments = []; // Clear comments as well for a full reset
                    });
                    saveParticipants();
                    showAdminMessage(document.getElementById('add-participant-manual-message'), `Status aller Teilnehmer zurückgesetzt.`, false);
                }
                
                deleteModal.classList.add('hidden');
                itemToDelete = null;
            });

            // --- Search & Filter Logic ---
            participantSearchInput.addEventListener('input', () => {
                renderUnifiedParticipantList();
            });

            function generateAlphabetFilters() {
                const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                
                // First name filter
                filterFirstNameSelect.innerHTML = '<option value="ALLE">Alle</option>';
                for (const letter of alphabet) {
                    const option = document.createElement('option');
                    option.value = letter;
                    option.textContent = letter;
                    filterFirstNameSelect.appendChild(option);
                }
                filterFirstNameSelect.value = currentFirstNameFilter; // Set selected value

                // Last name filter
                filterLastNameSelect.innerHTML = '<option value="ALLE">Alle</option>';
                for (const letter of alphabet) {
                    const option = document.createElement('option');
                    option.value = letter;
                    option.textContent = letter;
                    filterLastNameSelect.appendChild(option);
                }
                filterLastNameSelect.value = currentLastNameFilter; // Set selected value
            }
            
            // Event listeners for dropdown changes
            filterFirstNameSelect.addEventListener('change', (e) => {
                currentFirstNameFilter = e.target.value;
                renderUnifiedParticipantList();
            });

            filterLastNameSelect.addEventListener('change', (e) => {
                currentLastNameFilter = e.target.value;
                renderUnifiedParticipantList();
            });

            // Event listener for "Alle Teilnehmer anzeigen" button
            showAllParticipantsButton.addEventListener('click', () => {
                participantSearchInput.value = '';
                currentFirstNameFilter = 'ALLE';
                currentLastNameFilter = 'ALLE';
                filterFirstNameSelect.value = 'ALLE';
                filterLastNameSelect.value = 'ALLE';
                renderUnifiedParticipantList();
            });

            // --- Instruction Toggle Logic ---
            instructionToggleText.addEventListener('click', () => {
                fullInstructionsVisible = !fullInstructionsVisible;
                fullInstructions.classList.toggle('hidden', !fullInstructionsVisible);
                instructionToggleText.textContent = fullInstructionsVisible ? 'Instruktionen ausblenden' : 'für weitere Instruktionen hier klicken';
            });


            // Initialisierung
            loadUsers();
            loadParticipants();
            loadControlMode();

            // Zusätzliche Tailwind CSS-Klassen für Tastenfeld-Buttons für konsistentes Styling
            // This block was moved to the <style> section to apply immediately on load
            // document.querySelectorAll('.keypad-button').forEach(button => {
            //     button.classList.add('bg-gray-200', 'hover:bg-gray-300', 'active:bg-gray-400', 'text-gray-800', 'font-semibold', 'py-4', 'px-6', 'rounded-lg', 'shadow-md', 'transition-all', 'duration-200', 'text-2xl');
            // });
        </script>
    </div>
</body>
</html>
